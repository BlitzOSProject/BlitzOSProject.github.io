<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml"
xmlns:css="http://macVmlSchemaUri" xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta name=Title content="proj 1">
<meta name=Keywords content="">
<meta http-equiv=Content-Type content="text/html; charset=macintosh">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 2008">
<meta name=Originator content="Microsoft Word 2008">
<link rel=File-List href="proj5_files/filelist.xml">
<title>proj 1</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>Harry H. Porter III</o:Author>
  <o:Template>Normal.dotm</o:Template>
  <o:LastAuthor>Harry</o:LastAuthor>
  <o:Revision>2</o:Revision>
  <o:TotalTime>4355</o:TotalTime>
  <o:LastPrinted>2009-03-26T01:18:00Z</o:LastPrinted>
  <o:Created>2009-03-26T01:18:00Z</o:Created>
  <o:LastSaved>2009-03-26T01:18:00Z</o:LastSaved>
  <o:Pages>2</o:Pages>
  <o:Words>11295</o:Words>
  <o:Characters>57607</o:Characters>
  <o:Lines>2215</o:Lines>
  <o:Paragraphs>1086</o:Paragraphs>
  <o:CharactersWithSpaces>79068</o:CharactersWithSpaces>
  <o:Version>12.0</o:Version>
 </o:DocumentProperties>
 <o:OfficeDocumentSettings>
  <o:AllowPNG/>
 </o:OfficeDocumentSettings>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:ActiveWritingStyle Lang="EN-US" VendorID="6" DLLVersion="2" NLCheck="0">1</w:ActiveWritingStyle>
  <w:TrackMoves>false</w:TrackMoves>
  <w:TrackFormatting/>
  <w:HyphenationZone>0</w:HyphenationZone>
  <w:DoNotHyphenateCaps/>
  <w:DrawingGridHorizontalSpacing>0 pt</w:DrawingGridHorizontalSpacing>
  <w:DrawingGridVerticalSpacing>0 pt</w:DrawingGridVerticalSpacing>
  <w:DisplayHorizontalDrawingGridEvery>0</w:DisplayHorizontalDrawingGridEvery>
  <w:DisplayVerticalDrawingGridEvery>0</w:DisplayVerticalDrawingGridEvery>
  <w:UseMarginsForDrawingGridOrigin/>
  <w:ValidateAgainstSchemas>false</w:ValidateAgainstSchemas>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:DoNotUnderlineInvalidXML/>
  <w:DrawingGridHorizontalOrigin>0 pt</w:DrawingGridHorizontalOrigin>
  <w:DrawingGridVerticalOrigin>0 pt</w:DrawingGridVerticalOrigin>
  <w:DoNotShadeFormData/>
  <w:Compatibility>
   <w:BreakWrappedTables/>
   <w:UseNormalStyleForList/>
   <w:DontUseIndentAsNumberingTabStop/>
   <w:DontGrowAutofit/>
   <w:FELineBreak11/>
   <w:WW11IndentRules/>
   <w:DontAutofitConstrainedTables/>
   <w:AutofitLikeWW11/>
   <w:HangulWidthLikeWW11/>
  </w:Compatibility>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="276">
 </w:LatentStyles>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
@font-face
	{font-family:"Courier New";
	panose-1:2 7 3 9 2 2 5 2 4 4;
	mso-font-charset:0;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:Times;
	panose-1:2 0 5 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:"New York";
	panose-1:2 2 5 2 6 3 5 6 2 4;
	mso-font-charset:77;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
 /* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:Times;
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:Times;
	mso-bidi-font-family:"Times New Roman";}
h1
	{mso-style-next:Normal;
	margin:0in;
	margin-bottom:.0001pt;
	text-align:justify;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:1;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:Times;
	mso-hansi-font-family:Times;
	mso-font-kerning:0pt;
	text-decoration:underline;
	text-underline:single;}
h2
	{mso-style-next:Normal;
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:2;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:Times;
	mso-hansi-font-family:Times;
	text-decoration:underline;
	text-underline:single;}
h3
	{mso-style-next:Normal;
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:3;
	font-size:14.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:Times;
	mso-hansi-font-family:Times;
	text-decoration:underline;
	text-underline:single;}
h4
	{mso-style-next:Normal;
	margin:0in;
	margin-bottom:.0001pt;
	text-align:center;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:4;
	font-size:20.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:Times;
	mso-hansi-font-family:Times;}
h5
	{mso-style-next:Normal;
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:5;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:"Courier New";
	mso-hansi-font-family:"Courier New";}
h6
	{mso-style-next:Normal;
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:none;
	page-break-after:avoid;
	mso-outline-level:6;
	mso-layout-grid-align:none;
	text-autospace:none;
	font-size:14.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:Times;
	mso-hansi-font-family:Times;
	color:black;}
p.MsoHeading7, li.MsoHeading7, div.MsoHeading7
	{mso-style-next:Normal;
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:none;
	page-break-after:avoid;
	mso-outline-level:7;
	tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
	mso-layout-grid-align:none;
	text-autospace:none;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:Times;
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:Times;
	mso-bidi-font-family:"Times New Roman";
	color:black;
	font-weight:bold;
	mso-bidi-font-weight:normal;}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	tab-stops:center 3.0in right 6.0in;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:Times;
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:Times;
	mso-bidi-font-family:"Times New Roman";}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	tab-stops:center 3.0in right 6.0in;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:Times;
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:Times;
	mso-bidi-font-family:"Times New Roman";}
p.MsoBodyText, li.MsoBodyText, div.MsoBodyText
	{margin:0in;
	margin-bottom:.0001pt;
	text-align:justify;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:Times;
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:Times;
	mso-bidi-font-family:"Times New Roman";}
p.MsoBodyTextIndent, li.MsoBodyTextIndent, div.MsoBodyTextIndent
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.25in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:Times;
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:Times;
	mso-bidi-font-family:"Times New Roman";}
p.MsoBodyText2, li.MsoBodyText2, div.MsoBodyText2
	{margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:11.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Courier New";
	mso-bidi-font-family:"Times New Roman";}
p.MsoBodyText3, li.MsoBodyText3, div.MsoBodyText3
	{margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Courier New";
	mso-bidi-font-family:"Times New Roman";}
p.MsoBodyTextIndent2, li.MsoBodyTextIndent2, div.MsoBodyTextIndent2
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:Times;
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:Times;
	mso-bidi-font-family:"Times New Roman";}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;
	text-underline:single;}
 /* Page Definitions */
@page
	{mso-page-border-surround-header:no;
	mso-page-border-surround-footer:no;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in .75in 1.0in .75in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-header:url(":proj5_files:header.htm") h1;
	mso-footer:url(":proj5_files:header.htm") f1;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ascii-font-family:"New York";
	mso-hansi-font-family:"New York";}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2050"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=EN-US link=blue vlink=purple style='tab-interval:.5in'>

<div class=Section1>

<p class=MsoNormal align=center style='text-align:center'><b style='mso-bidi-font-weight:
normal'><span style='font-size:20.0pt;mso-bidi-font-size:10.0pt'>Programming
Project 5:<o:p></o:p></span></b></p>

<h4>User-Level Processes</h4>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='text-align:justify'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='text-align:justify'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='text-align:justify'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><u><span
style='font-size:14.0pt;mso-bidi-font-size:10.0pt'>Due Date:</span></u></b><span
style='font-size:14.0pt;mso-bidi-font-size:10.0pt'> </span>______________________________</p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><u><span
style='font-size:14.0pt;mso-bidi-font-size:10.0pt'>Project Duration:</span></u></b><span
style='font-size:14.0pt;mso-bidi-font-size:10.0pt'><span style="mso-spacerun:
yes">&nbsp; </span></span>One week</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h3>Overview and Goal</h3>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>In this project, you will explore user-level processes.<span
style="mso-spacerun: yes">&nbsp; </span>You will create a single process,
running in its own address space.<span style="mso-spacerun: yes">&nbsp;
</span>When this user-level process executes, the CPU will be in “user mode.”</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The user-level process will make system calls to the kernel,
which will cause the CPU to switch into “system mode.”<span
style="mso-spacerun: yes">&nbsp; </span>Upon completion, the CPU will switch
back to user mode before resuming execution of the user-level process.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The user-level process will execute in its own “logical
address space.”<span style="mso-spacerun: yes">&nbsp; </span>Its address space
will be broken into a number of “pages” and each page will be stored in a frame
in memory.<span style="mso-spacerun: yes">&nbsp; </span>The pages will be resident
(i.e., stored in frames in physical memory) at all times and will not be
swapped out to disk in this project.<span style="mso-spacerun: yes">&nbsp;
</span>(Contrast this with “virtual” memory, in which some pages may not be
resident in memory.)</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The kernel will be entirely protected from the user-level
program; nothing the user-level program does can crash the kernel.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>Download New Files</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The files for this project are available in:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'><span style='font-family:Courier'>http://www.cs.pdx.edu/~harry/Blitz/OSProject/p5/</span></b><span
style='font-family:"Courier New"'><o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Please retain your old files from previous projects and don’t
modify them once you submit them.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>You should get the following files:</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-family:"Courier New"'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><b style='mso-bidi-font-weight:
normal'>Switch.s<o:p></o:p></b></span></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>Runtime.s<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>System.h<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>System.c<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>List.h<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>List.c<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>BitMap.h<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>BitMap.c<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><o:p>&nbsp;</o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>makefile<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>FileStuff.h<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>FileStuff.c<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>Main.h<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>Main.c<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>DISK<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><o:p>&nbsp;</o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>UserRuntime.s<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>UserSystem.h<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>UserSystem.c<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>MyProgram.h<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>MyProgram.c<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>TestProgram1.h<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>TestProgram1.c<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>TestProgram2.h<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>TestProgram2.c<o:p></o:p></span></b></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The following files are unchanged from the last project and
you should not modify them:</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-family:"Courier New"'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><b style='mso-bidi-font-weight:
normal'>Switch.s<o:p></o:p></b></span></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>Runtime.s<o:p></o:p></span></b></p>

<h5><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>System.h</h5>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>System.c</span></b><span
style="mso-spacerun: yes">&nbsp; </span>-- except HEAP_SIZE has been modified<b
style='mso-bidi-font-weight:normal'><span style='font-family:"Courier New"'><o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>List.h<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>List.c<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>BitMap.h<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>BitMap.c<o:p></o:p></span></b></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The following files are not provided; instead you will
modify what you created in the last project.<span style="mso-spacerun:
yes">&nbsp; </span><u>Copy</u> these files to your <b style='mso-bidi-font-weight:
normal'>p5</b> directory, so that you keep the previous <b style='mso-bidi-font-weight:
normal'>p4</b> versions in your <b style='mso-bidi-font-weight:normal'>p4</b>
directory, and modify the new copies.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>Kernel.h<o:p></o:p></span></b></p>

<h5><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>Kernel.c<span
style='font-family:Times'><o:p></o:p></span></h5>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>Merging New “File Stuff” Code</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>For this project, we are distributing additional code which
you should add to the <b style='mso-bidi-font-weight:normal'>Kernel</b>
package.<span style="mso-spacerun: yes">&nbsp; </span>Please add the material
in <b style='mso-bidi-font-weight:normal'>FileStuff.c</b> to the end of file <b
style='mso-bidi-font-weight:normal'>Kernel.c.</b><span style="mso-spacerun:
yes">&nbsp; </span>It should be inserted directly before the final <b
style='mso-bidi-font-weight:normal'>endCode</b> keyword.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Also, please add the material in <b style='mso-bidi-font-weight:
normal'>FileStuff.h</b> to the end of file <b style='mso-bidi-font-weight:normal'>Kernel.h</b>.<span
style="mso-spacerun: yes">&nbsp; </span>It should be inserted directly before
the final <b style='mso-bidi-font-weight:normal'>endHeader</b> keyword.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>This code adds the following classes:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>DiskDriver<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>FileManager<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>FileControlBlock<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>OpenFile</b></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>You will use these classes, but you should not modify them.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>There will be a single <b style='mso-bidi-font-weight:normal'>DiskDriver</b>
object (called <b style='mso-bidi-font-weight:normal'>diskDriver</b>) which is
created and initialized at start-up time.<span style="mso-spacerun: yes">&nbsp;
</span>There will be a single <b style='mso-bidi-font-weight:normal'>FileManager</b>
object (called <b style='mso-bidi-font-weight:normal'>fileManager</b>) which is
created and initialized at start-up time.<span style="mso-spacerun: yes">&nbsp;
</span>The new <b style='mso-bidi-font-weight:normal'>main</b> function
contains statements to create and initialize the <b style='mso-bidi-font-weight:
normal'>diskDriver</b> and the <b style='mso-bidi-font-weight:normal'>fileManager</b>
objects.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'>FileControlBlock</b>
and <b style='mso-bidi-font-weight:normal'>OpenFile</b> objects will be handled
much like <b style='mso-bidi-font-weight:normal'>Threads</b> and <b
style='mso-bidi-font-weight:normal'>ProcessControlBlocks</b>.<span
style="mso-spacerun: yes">&nbsp; </span>They are a limited resource.<span
style="mso-spacerun: yes">&nbsp; </span>A limited supply is created at start-up
time and then they are managed by the <b style='mso-bidi-font-weight:normal'>fileManager</b>.<span
style="mso-spacerun: yes">&nbsp; </span>There is a free list of <b
style='mso-bidi-font-weight:normal'>FileControlBlock</b> objects and a free
list of <b style='mso-bidi-font-weight:normal'>OpenFile</b> objects.<span
style="mso-spacerun: yes">&nbsp;&nbsp; </span>The <b style='mso-bidi-font-weight:
normal'>fileManager</b> oversees both of these free lists.<span
style="mso-spacerun: yes">&nbsp; </span>Threads may make requests and may
return resources, by invoking methods in the <b style='mso-bidi-font-weight:
normal'>fileManager</b>.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The <b style='mso-bidi-font-weight:normal'>diskDriver</b>
object encapsulates all the hardware specific details of the disk.<span
style="mso-spacerun: yes">&nbsp; </span>It provides a method that allows a
thread to read a sector from disk into a memory frame and it provides a method
that writes a frame from memory to a sector on disk.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>Other Changes To Your Kernel Code</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Please make the following changes to your copy of <b
style='mso-bidi-font-weight:normal'>Kernel.h</b>:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Change</p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>NUMBER_OF_PHYSICAL_PAGE_FRAMES
= 27<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-- for
testing only<o:p></o:p></span></p>

<p class=MsoNormal>to:</p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>NUMBER_OF_PHYSICAL_PAGE_FRAMES
= 100<span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>-- for testing only<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Change</p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>--diskDriver:
DiskDriver<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>--fileManager:
FileManager<o:p></o:p></span></p>

<p class=MsoNormal>to:</p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>diskDriver:
DiskDriver<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>fileManager:
FileManager<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Add a function prototype for the function <b
style='mso-bidi-font-weight:normal'>InitFirstProcess</b>.<span
style="mso-spacerun: yes">&nbsp; </span>You can add it after the other function
prototypes:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Change</p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>ProcessFinish (exitStatus:
int)<o:p></o:p></span></p>

<p class=MsoNormal>to:</p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>ProcessFinish (exitStatus:
int)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>InitFirstProcess ()<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Please make the following changes to your copy of <b
style='mso-bidi-font-weight:normal'>Kernel.c</b>:</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Change the <b style='mso-bidi-font-weight:normal'>DiskInterruptHandler</b>
function from:</p>

<p class=MsoNormal><span style='font-family:Courier'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>FatalError (&quot;DISK INTERRUPTS NOT
EXPECTED IN PROJECT 4&quot;)<o:p></o:p></span></p>

<p class=MsoNormal>to:</p>

<p class=MsoNormal><span style='font-family:Courier'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>currentInterruptStatus = DISABLED<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-family:Courier'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>-- print (&quot;DiskInterruptHandler
invoked!\n&quot;)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-family:Courier'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>if diskDriver.semToSignalOnCompletion<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-family:Courier'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes">&nbsp;
</span>diskDriver.semToSignalOnCompletion.Up()<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-family:Courier'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>endIf<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>Task 1:</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Your first task is to load and execute the user-level
program called <b style='mso-bidi-font-weight:normal'>MyProgram</b>.<span
style="mso-spacerun: yes">&nbsp; </span>Since the user-level program must be
read from a file on the BLITZ disk, you’ll first need to understand how the
BLITZ disk works, how files are stored on the disk, and how the <b
style='mso-bidi-font-weight:normal'>FileManager</b> code works.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'>MyProgram</b> invokes
the <b style='mso-bidi-font-weight:normal'>SystemShutdown</b> syscall, which
you’ll need to implement.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>Task 2:</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Modify all the syscall handlers so they print the arguments
that are passed to them.<span style="mso-spacerun: yes">&nbsp; </span>In the
case of integer arguments, this should be straightforward, but the following
syscalls take a pointer to an array of char as one of their arguments.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Exec<o:p></o:p></b></p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Create<o:p></o:p></b></p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Open<o:p></o:p></b></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>This pointer is in the user-program’s
logical address space.<span style="mso-spacerun: yes">&nbsp; </span>You must
first move the string from user-space to a buffer in kernel space.<span
style="mso-spacerun: yes">&nbsp; </span>Only then can it be safely printed.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>Also, some of the syscalls return a
result.<span style="mso-spacerun: yes">&nbsp; </span>You must modify the
handlers for these syscalls so that the following syscalls return these
values.<span style="mso-spacerun: yes">&nbsp; </span>(These are just arbitrary
values, to make sure you can return something.)</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in 1.25in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Fork</b><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>1000</p>

<p class=MsoFooter style='tab-stops:.5in 1.25in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Join</b><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>2000</p>

<p class=MsoFooter style='tab-stops:.5in 1.25in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Exec</b><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>3000</p>

<p class=MsoFooter style='tab-stops:.5in 1.25in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Create</b><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>4000</p>

<p class=MsoFooter style='tab-stops:.5in 1.25in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Open</b><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>5000</p>

<p class=MsoFooter style='tab-stops:.5in 1.25in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Read</b><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>6000</p>

<p class=MsoFooter style='tab-stops:.5in 1.25in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Write</b><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>7000</p>

<p class=MsoFooter style='tab-stops:.5in 1.25in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Seek</b><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>8000</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>For this task, you should modify only
the handler methods (e.g., <b style='mso-bidi-font-weight:normal'>Handle_Sys_Fork</b>,
<b style='mso-bidi-font-weight:normal'>Handle_Sys_Join</b>, etc.)<span
style="mso-spacerun: yes">&nbsp; </span>You should <u>not</u> modify <b
style='mso-bidi-font-weight:normal'>SyscallTrapHandler</b> or the wrapper
functions in <b style='mso-bidi-font-weight:normal'>UserSystem</b>.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>Task 3:</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Implement the <b style='mso-bidi-font-weight:normal'>Exec</b>
syscall.<span style="mso-spacerun: yes">&nbsp; </span>The <b style='mso-bidi-font-weight:
normal'>Exec</b> syscall will read a new executable program from disk and copy
it into the address space of the process which invoked the <b style='mso-bidi-font-weight:
normal'>Exec</b>.<span style="mso-spacerun: yes">&nbsp; </span>It will then
begin execution of the new program.<span style="mso-spacerun: yes">&nbsp;
</span>Unless there are errors, there will not be a return from the <b
style='mso-bidi-font-weight:normal'>Exec</b> syscall.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>The User-Level View</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>First, let’s look at our operating system from the users’
point of view.<span style="mso-spacerun: yes">&nbsp; </span>User-level programs
will be able to invoke the following kernel routines:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Exit<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Shutdown<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Yield<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Fork<o:p></o:p></b></p>

<p class=MsoFooter style='tab-stops:.5in'><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Join<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Exec<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Create<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Open<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Read<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Write<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Seek<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Close<o:p></o:p></b></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>(This is the grand plan for our OS; these system calls will
not be implemented in this project.)</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>These syscalls are quite similar to kernel syscalls of the
same names in Unix.<span style="mso-spacerun: yes">&nbsp; </span>We describe
their precise functionality later.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>A user-level program will be written in KPL and linked with
the following files:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>UserSystem.h<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>UserSystem.c<o:p></o:p></b></p>

<h5><span style='font-family:Times'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>UserRuntime.s<o:p></o:p></span></h5>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>We are providing a sample user-level program in <b
style='mso-bidi-font-weight:normal'>MyProgram.h / .c</b>.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The <b style='mso-bidi-font-weight:normal'>UserSystem</b>
package includes a wrapper (or “jacket”) function for each of the system
calls.<span style="mso-spacerun: yes">&nbsp; </span>Here are the names of the
wrapper functions.<span style="mso-spacerun: yes">&nbsp; </span>There is a
one-to-one correspondence between the system calls and the wrapper functions.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='tab-stops:.5in 121.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'><u>System call</u></b><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'><u>Wrapper function name</u></b></p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Exit<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sys_Exit</p>

<p class=MsoFooter style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Shutdown<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sys_Shutdown</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Yield<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sys_Yield</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Fork<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sys_Fork</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Join<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sys_Join</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Exec<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sys_Exec</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Create<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sys_Create</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Open<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sys_Open</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Read<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sys_Read</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Write<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sys_Write</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Seek<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sys_Seek</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Close<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sys_Close</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>(In Unix, the wrapper function often has the same name as
the syscall.<span style="mso-spacerun: yes">&nbsp; </span>All wrapper functions
have names beginning with<span style="mso-spacerun: yes">&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Sys_</b><span style="mso-spacerun:
yes">&nbsp; </span>just to help make the distinction between wrapper and
syscall.)</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Each wrapper function works the same way.<span
style="mso-spacerun: yes">&nbsp; </span>It invokes an assembly language routine
called <b style='mso-bidi-font-weight:normal'>DoSyscall</b>, which executes a
“syscall” machine instruction.<span style="mso-spacerun: yes">&nbsp;
</span>When the kernel call finishes, the <b style='mso-bidi-font-weight:normal'>DoSyscall</b>
function simply returns to the wrapper function, which returns to the user’s
code.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Arguments may be passed to and from the kernel call.<span
style="mso-spacerun: yes">&nbsp; </span>In general, these are integers and
pointers to memory.<span style="mso-spacerun: yes">&nbsp; </span>The wrapper
function works with <b style='mso-bidi-font-weight:normal'>DoSyscall</b> to
pass the arguments.<span style="mso-spacerun: yes">&nbsp; </span>When the
wrapper function calls <b style='mso-bidi-font-weight:normal'>DoSyscall</b>, it
will push the arguments onto the stack.<span style="mso-spacerun: yes">&nbsp;
</span>The <b style='mso-bidi-font-weight:normal'>DoSyscall</b> will take the
arguments off the stack and move them into registers.<span style="mso-spacerun:
yes">&nbsp; </span>Since it runs as a user-level function, it places them in
the “user” registers.<span style="mso-spacerun: yes">&nbsp; </span>(Recall that
the BLITZ machine has a set of 16 “system registers” and a set of 16 “user
registers.”)</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Each wrapper function also uses an integer code to indicate
which kernel function is involved.<span style="mso-spacerun: yes">&nbsp;
</span>Here is the <b style='mso-bidi-font-weight:normal'>enum</b> giving the
different codes.<span style="mso-spacerun: yes">&nbsp; </span>For example, the
code for “Fork” is 4.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp; </span>enum SYSCALL_EXIT = 1,<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>SYSCALL_SHUTDOWN,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SYSCALL_YIELD,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SYSCALL_FORK,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SYSCALL_JOIN,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SYSCALL_EXEC,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SYSCALL_CREATE,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SYSCALL_OPEN,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SYSCALL_READ,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SYSCALL_WRITE,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SYSCALL_SEEK,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SYSCALL_CLOSE<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>These code numbers are used both by the user-level program
and by the kernel.<span style="mso-spacerun: yes">&nbsp; </span>Consequently,
there is an identical copy of this <b style='mso-bidi-font-weight:normal'>enum</b>
in both <b style='mso-bidi-font-weight:normal'>Kernel.h </b>and <b
style='mso-bidi-font-weight:normal'>UserSystem.h</b>.<span style="mso-spacerun:
yes">&nbsp; </span>(You should not change the system call interface, but if one
were to change these code numbers, it would be critical that both<b
style='mso-bidi-font-weight:normal'> enum</b>s were changed identically.)</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>As an example, here is the code for the wrapper function for
“Read.”<span style="mso-spacerun: yes">&nbsp; </span>It simply invokes <b
style='mso-bidi-font-weight:normal'>DoSyscall</b> and returns whatever <b
style='mso-bidi-font-weight:normal'>DoSyscall</b> returns.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>function</u> Sys_Read
(fileDesc: <u>int</u>,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>buffer: <u>ptr</u> <u>to</u> <u>char</u>,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>sizeInBytes: <u>int</u>) <u>returns</u> <u>int</u><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><u>return</u>
DoSyscall (SYSCALL_READ,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>fileDesc,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>buffer <u>asInteger</u>,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>sizeInBytes,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>0)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><u>endFunction<o:p></o:p></u></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Here is the function prototype for <b style='mso-bidi-font-weight:
normal'>DoSyscall</b>:</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>external</u> DoSyscall
(funCode, arg1, arg2, arg3, arg4: <u>int</u>) <u>returns</u> <u>int</u> <o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The <b style='mso-bidi-font-weight:normal'>DoSyscall</b>
routine is set up to deal with up to 4 arguments.<span style="mso-spacerun:
yes">&nbsp; </span>Since the <b style='mso-bidi-font-weight:normal'>Read</b>
syscall only needs 3 arguments, the wrapper function must supply an extra zero
for the fourth argument.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'>DoSyscall</b> treats
all of its arguments as untyped words (i.e., as <b style='mso-bidi-font-weight:
normal'>int</b>), so the wrapper functions must coerce the types of the
arguments if they are not <b style='mso-bidi-font-weight:normal'>int</b>.<span
style="mso-spacerun: yes">&nbsp; </span>Whatever <b style='mso-bidi-font-weight:
normal'>DoSyscall</b> returns, the wrapper function will return.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'>DoSyscall</b> is in <b
style='mso-bidi-font-weight:normal'>UserRuntime.s</b>, which will be linked
with all user programs.<span style="mso-spacerun: yes">&nbsp; </span>The code
is given next.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>It moves each of the 4 arguments into registers r1, r2, r3,
and r4.<span style="mso-spacerun: yes">&nbsp; </span>It then moves the function
code into register r5 and executes the <b style='mso-bidi-font-weight:normal'>syscall</b>
instruction.<span style="mso-spacerun: yes">&nbsp; </span>It assumes the kernel
will place the result (if any) in r1, so after the <b style='mso-bidi-font-weight:
normal'>syscall</b> instruction, it moves the return value from r1 to the
stack, so that the wrapper function can retrieve it.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<span style='font-size:10.0pt;font-family:Courier;mso-fareast-font-family:"Times New Roman";
mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-US;mso-fareast-language:
EN-US'><br clear=ALL style='page-break-before:always'>
</span>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-size:10.0pt;font-family:Courier'>DoSyscall:<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.5in 63.0pt 1.75in 225.0pt'><span
style='font-size:10.0pt;font-family:Courier'><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>load<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>[r15+8],r1<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>! Move arg1
into r1<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in 63.0pt 1.75in 225.0pt'><span
style='font-size:10.0pt;font-family:Courier'><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>load<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>[r15+12],r2<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>! Move arg2 into
r2<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in 63.0pt 1.75in 225.0pt'><span
style='font-size:10.0pt;font-family:Courier'><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>load<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>[r15+16],r3<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>! Move arg3 into
r3<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in 63.0pt 1.75in 225.0pt'><span
style='font-size:10.0pt;font-family:Courier'><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>load<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>[r15+20],r4<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>! Move arg4 into
r4<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in 63.0pt 1.75in 225.0pt'><span
style='font-size:10.0pt;font-family:Courier'><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>load<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>[r15+4],r5<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>! Move
funcCode into r5<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in 63.0pt 1.75in 225.0pt'><span
style='font-size:10.0pt;font-family:Courier'><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>syscall<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp; </span>r5<span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>!
Do the syscall<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in 63.0pt 1.75in 225.0pt'><span
style='font-size:10.0pt;font-family:Courier'><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>store<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>r1,[r15+4]<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>! Move
result from r1 onto stack<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in 63.0pt 1.75in 225.0pt'><span
style='font-size:10.0pt;font-family:Courier'><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ret<span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>!
Return<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Some of the kernel routines require no arguments and/or
return no result.<span style="mso-spacerun: yes">&nbsp; </span>As an example,
consider the wrapper function for <b style='mso-bidi-font-weight:normal'>Yield</b>.<span
style="mso-spacerun: yes">&nbsp; </span>The compiler knows that <b
style='mso-bidi-font-weight:normal'>DoSyscall</b> returns a result, so it
insists that we do something with this value.<span style="mso-spacerun:
yes">&nbsp; </span>The wrapper function simply moves it into a variable and
ignores it.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>function</u> Sys_Yield ()<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>var ignore: <u>int</u><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ignore = DoSyscall (SYSCALL_YIELD, 0, 0, 0, 0)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><u>endFunction</u><o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>Here is a list of all the wrapper
functions, including their arguments and return types. </p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Sys_Exit</b> (returnStatus: <u>int</u>)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Sys_Shutdown</b> ()<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Sys_Yield</b> ()<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Sys_Fork</b> () <u>returns</u> <u>int</u><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Sys_Join</b> (processID: <u>int</u>) <u>returns</u>
<u>int</u><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Sys_Exec</b> (filename: String) <u>returns</u>
<u>int</u><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Sys_Create</b> (filename: String) <u>returns</u>
<u>int</u><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Sys_Open</b> (filename: String) <u>returns</u>
<u>int</u><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Sys_Read</b> (fileDesc: <u>int</u>, buffer:
<u>ptr</u> <u>to</u> char, sizeInBytes: <u>int</u>)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='mso-tab-count:5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>returns
<u>int</u><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Sys_Write</b> (fileDesc: <u>int</u>,
buffer: <u>ptr</u> <u>to</u> char, sizeInBytes: <u>int</u>)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:11'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>returns
<u>int</u><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Sys_Seek</b> (fileDesc: <u>int</u>,
newCurrentPos: <u>int</u>) returns <u>int</u><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'>Sys_Close</b> (fileDesc: <u>int</u>)<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>In addition to the wrapper functions, the <b
style='mso-bidi-font-weight:normal'>UserSystem</b> package contains a few other
routines that support the KPL language.<span style="mso-spacerun: yes">&nbsp;
</span>These are more-or-less duplicates of the same routines in the <b
style='mso-bidi-font-weight:normal'>System</b> package.<span
style="mso-spacerun: yes">&nbsp; </span>Likewise, some of the material from <b
style='mso-bidi-font-weight:normal'>Runtime.s</b> is duplicated in <b
style='mso-bidi-font-weight:normal'>UserRuntime.s</b>.<span
style="mso-spacerun: yes">&nbsp; </span>This duplication is necessary because user-level
programs cannot invoke any of the routines that are part of the kernel.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>For example the functions <b style='mso-bidi-font-weight:
normal'>print</b>, <b style='mso-bidi-font-weight:normal'>printInt</b>, <b
style='mso-bidi-font-weight:normal'>nl</b>, etc. have been duplicated at the
user level so the user-level program has the ability to print.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>[Note that, at this point, all printing is done by cheating,
using a “trapdoor” in the emulator.<span style="mso-spacerun: yes">&nbsp;
</span>Normally, a user-level program would need to invoke syscalls (such as <b
style='mso-bidi-font-weight:normal'>Sys_Write</b>) to perform any output, since
user-level programs can’t access the I/O devices directly.<span
style="mso-spacerun: yes">&nbsp; </span>However, since we are not yet ready to
address questions about output to the serial device, we are including these
cheater print functions, which rely on a trapdoor in the emulator.]</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Every user-level program needs to “use” the <b
style='mso-bidi-font-weight:normal'>UserSystem</b> package and be linked with
the <b style='mso-bidi-font-weight:normal'>UserRuntime.s</b> code.<span
style="mso-spacerun: yes">&nbsp; </span>For example:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><u>MyProgram.h<o:p></o:p></u></b></p>

<p class=MsoFooter style='tab-stops:.75in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>header
MyProgram<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.75in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp; </span>uses UserSystem<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.75in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp; </span>functions<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.75in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>main ()<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.75in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>endHeader<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><u>MyProgram.c<o:p></o:p></u></b></p>

<p class=MsoFooter style='tab-stops:.75in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>code
MyProgram<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.75in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp; </span>function main ()<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.75in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>print (&quot;My
user-level program is running!\n&quot;)<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.75in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Sys_Shutdown ()<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.75in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>endFunction<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.75in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>endCode<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>Here are the commands to prepare a
user-level program for execution.<span style="mso-spacerun: yes">&nbsp;
</span>The <b style='mso-bidi-font-weight:normal'>makefile</b> has been
modified to include these commands.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Courier'>asm<span style="mso-spacerun: yes">&nbsp;
</span>UserRuntime.s<o:p></o:p></span></p>

<p class=MsoFooter style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Courier'>comp UserSystem -unsafe<o:p></o:p></span></p>

<p class=MsoFooter style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Courier'>asm<span style="mso-spacerun: yes">&nbsp;
</span>UserSystem.s<o:p></o:p></span></p>

<p class=MsoFooter style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Courier'>comp MyProgram -unsafe<o:p></o:p></span></p>

<p class=MsoFooter style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Courier'>asm<span style="mso-spacerun: yes">&nbsp;
</span>MyProgram.s<o:p></o:p></span></p>

<p class=MsoFooter style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Courier'>lddd UserRuntime.o UserSystem.o MyProgram.o -o MyProgram<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>Note that there is no connection with
the kernel.<span style="mso-spacerun: yes">&nbsp; </span>The user-level
programs are compiled and linked independently.<span style="mso-spacerun:
yes">&nbsp; </span>All communication with the kernel will be through the
syscall interface, via the wrapper functions.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>This is exactly the way Unix
works.<span style="mso-spacerun: yes">&nbsp; </span>For user-level programs,
library functions and wrapper functions are brought into the “a.out” file at
link-time, as needed.<span style="mso-spacerun: yes">&nbsp; </span>This
explains why a seemingly small “C” program can produce a rather large “a.out”
executable.<span style="mso-spacerun: yes">&nbsp; </span>One small use of <b
style='mso-bidi-font-weight:normal'>printf</b> in a program might pull in, at
link-time, more output formatting and buffering routines than you can possibly
imagine.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>When an OS wants to execute a
user-level program, it will go to a disk file to find the executable.<span
style="mso-spacerun: yes">&nbsp; </span>Then it will read that executable into
memory and start up the new process.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>In order to execute MyProgram, we
need to introduce the BLITZ “disk.”<span style="mso-spacerun: yes">&nbsp;
</span>The disk is simulated with a Unix file called “DISK.”<span
style="mso-spacerun: yes">&nbsp; </span>After the user-level program is
compiled, it must be placed on the BLITZ disk with the following Unix commands:</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Courier'>diskUtil -i<o:p></o:p></span></p>

<p class=MsoFooter style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Courier'>diskUtil -a MyProgram MyProgram<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>The first command creates an empty
file system on the disk.<span style="mso-spacerun: yes">&nbsp; </span>The
second command copies a file from the Unix file system to the BLITZ disk.<span
style="mso-spacerun: yes">&nbsp; </span>It creates a directory entry and moves
the data to the proper place on the simulated BLITZ disk.<span
style="mso-spacerun: yes">&nbsp; </span>Commands to initialize the BLITZ disk
have also been added to the <b style='mso-bidi-font-weight:normal'>makefile</b>.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>Once the kernel is running, it will
read the file from the simulated BLITZ disk and copy it into memory.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>The Syscall Interface</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>In our OS, each process will have exactly one thread.<span
style="mso-spacerun: yes">&nbsp; </span>A process may also have several open
files and can do I/O via the <b style='mso-bidi-font-weight:normal'>Read</b>
and <b style='mso-bidi-font-weight:normal'>Write</b> syscalls.<span
style="mso-spacerun: yes">&nbsp; </span>The I/O will go to the BLITZ disk.<span
style="mso-spacerun: yes">&nbsp; </span>For now, there is no serial (i.e., terminal)
device.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Next we describe each syscall in more detail.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.25in'><b style='mso-bidi-font-weight:
normal'>function Sys_Exit (returnStatus: int)<o:p></o:p></b></p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoBodyTextIndent2>This function causes the current process and its
thread to terminate.<span style="mso-spacerun: yes">&nbsp; </span>The <b
style='mso-bidi-font-weight:normal'>returnStatus</b> will be saved so that it
can be passed to a <b style='mso-bidi-font-weight:normal'>Sys_Join</b> executed
by the parent process.<span style="mso-spacerun: yes">&nbsp; </span>This
function never returns.</p>

<p class=MsoNormal style='margin-left:.25in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.25in'><b style='mso-bidi-font-weight:
normal'>function Sys_Shutdown ()<o:p></o:p></b></p>

<p class=MsoBodyTextIndent2><o:p>&nbsp;</o:p></p>

<p class=MsoBodyTextIndent2>This function will cause an immediate shutdown of
the kernel.<span style="mso-spacerun: yes">&nbsp; </span>It will not return.</p>

<p class=MsoNormal style='margin-left:.25in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.25in'><b style='mso-bidi-font-weight:
normal'>function Sys_Yield ()<o:p></o:p></b></p>

<p class=MsoBodyTextIndent2><o:p>&nbsp;</o:p></p>

<p class=MsoBodyTextIndent2>This function yields the CPU to another process on
the ready list.<span style="mso-spacerun: yes">&nbsp; </span>Once this process
is scheduled again, this function will return.<span style="mso-spacerun:
yes">&nbsp; </span>From the caller’s perspective, this routine is similar to a
“nop.”</p>

<p class=MsoNormal style='margin-left:.25in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.25in'><b style='mso-bidi-font-weight:
normal'>function Sys_Fork () returns int<o:p></o:p></b></p>

<p class=MsoBodyTextIndent2><o:p>&nbsp;</o:p></p>

<p class=MsoBodyTextIndent2>This function creates a new process which is a copy
of the current process.<span style="mso-spacerun: yes">&nbsp; </span>The new
process will have a copy of the virtual memory space and all files open in the
original process will also be open in the new process.<span
style="mso-spacerun: yes">&nbsp; </span>Both processes will then return from
this function.<span style="mso-spacerun: yes">&nbsp; </span>In the parent
process, the <b style='mso-bidi-font-weight:normal'>pid</b> of the child will
be returned; in the child, zero will be returned.</p>

<p class=MsoNormal style='margin-left:.25in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.25in'><b style='mso-bidi-font-weight:
normal'>function Sys_Join (processID: int) returns int<o:p></o:p></b></p>

<p class=MsoBodyTextIndent2><o:p>&nbsp;</o:p></p>

<p class=MsoBodyTextIndent2>This function causes the caller to wait until the
process with the given <b style='mso-bidi-font-weight:normal'>pid</b> has
terminated, by executing a call to <b style='mso-bidi-font-weight:normal'>Sys_Exit</b>.<span
style="mso-spacerun: yes">&nbsp; </span>The <b style='mso-bidi-font-weight:
normal'>returnStatus</b> passed by that process to <b style='mso-bidi-font-weight:
normal'>Sys_Exit</b> will be returned from this function.<span
style="mso-spacerun: yes">&nbsp; </span>If the other process invokes <b
style='mso-bidi-font-weight:normal'>Sys_Exit</b> first, this <b
style='mso-bidi-font-weight:normal'>returnStatus</b> will be saved until either
its parent executes a <b style='mso-bidi-font-weight:normal'>Sys_Join</b>
naming that process’s <b style='mso-bidi-font-weight:normal'>pid</b> or until
its parent terminates.</p>

<p class=MsoNormal style='margin-left:.25in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.25in'><b style='mso-bidi-font-weight:
normal'>function Sys_Exec (filename: String) returns int<o:p></o:p></b></p>

<p class=MsoBodyTextIndent2><o:p>&nbsp;</o:p></p>

<p class=MsoBodyTextIndent2>This function is passed the name of a file.<span
style="mso-spacerun: yes">&nbsp; </span>That file is assumed to be an
executable file.<span style="mso-spacerun: yes">&nbsp; </span>It is read in to
memory, overwriting the entire address space of the current process.<span
style="mso-spacerun: yes">&nbsp; </span>Then the OS will begin executing the
new process.<span style="mso-spacerun: yes">&nbsp; </span>Any open files in the
current process will remain open and unchanged in the new process. Normally,
this function will not return.<span style="mso-spacerun: yes">&nbsp; </span>If
there are problems, this function will return -1.</p>

<p class=MsoNormal style='margin-left:.25in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.25in'><b style='mso-bidi-font-weight:
normal'>function Sys_Create (filename: String) returns int<o:p></o:p></b></p>

<p class=MsoBodyTextIndent2><o:p>&nbsp;</o:p></p>

<p class=MsoBodyTextIndent2>This function creates a new file on the disk.<span
style="mso-spacerun: yes">&nbsp; </span>If all is okay, it returns 0, otherwise
it returns a non-zero error code.<span style="mso-spacerun: yes">&nbsp;
</span>This function does not open the file; so the caller must use <b
style='mso-bidi-font-weight:normal'>Sys_Open</b> before attempting any I/O.</p>

<p class=MsoNormal style='margin-left:.25in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.25in'><b style='mso-bidi-font-weight:
normal'>function Sys_Open (filename: String) returns int<o:p></o:p></b></p>

<p class=MsoBodyTextIndent2><o:p>&nbsp;</o:p></p>

<p class=MsoBodyTextIndent2>This function opens a file.<span
style="mso-spacerun: yes">&nbsp; </span>The file must exist already exist. If
all is OK, this function returns a file descriptor, which is a small,
non-negative integer.<span style="mso-spacerun: yes">&nbsp; </span>It errors
occur, this function returns -1.</p>

<p class=MsoNormal style='margin-left:.25in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.25in'><b style='mso-bidi-font-weight:
normal'>function Sys_Read (fileDesc: int, buffer: ptr to char, sizeInBytes:
int) returns int<o:p></o:p></b></p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in'>This function is passed the <b
style='mso-bidi-font-weight:normal'>fileDescriptor</b> of a file (which is
assumed to have been successfully opened), a pointer to an area of memory, and
a count of the number of bytes to transfer.<span style="mso-spacerun:
yes">&nbsp; </span>This function reads that many bytes from the current position
in the file and places them in memory.<span style="mso-spacerun: yes">&nbsp;
</span>If there are not enough bytes between the current position and the end
of the file, then a lesser number of bytes are transferred.<span
style="mso-spacerun: yes">&nbsp; </span>The current file position will be
advanced by the number of bytes transferred.</p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in'>If the input is coming from the
serial device (the terminal), this function will wait for at least one
character to be typed before returning, and then will return as many characters
as have been typed and buffered since the previous call to this function.</p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoBodyTextIndent style='margin-left:.5in'>This function will return
the<span style="mso-spacerun: yes">&nbsp; </span>number of characters
moved.<span style="mso-spacerun: yes">&nbsp; </span>If there are errors, it
will return -1.</p>

<p class=MsoNormal style='margin-left:.25in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.25in'><b style='mso-bidi-font-weight:
normal'>function Sys_Write (fileDesc: int, buffer: ptr to char, sizeInBytes:
int) returns int<o:p></o:p></b></p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in'>This function is passed the <b
style='mso-bidi-font-weight:normal'>fileDescriptor</b> of a file (which is assumed
to have been successfully opened), a pointer to an area of memory, and a count
of the number of bytes to transfer.<span style="mso-spacerun: yes">&nbsp;
</span>This function writes that many bytes from the memory to the current
position in the file.</p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoBodyTextIndent2>If the end of the file is reached, the file’s size
will be increased.</p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in'>The current file position will be
advanced by the number of bytes transferred, so that future writes will follow
the data transferred in this invocation.</p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in'>The output may also be directed to
the serial output, i.e., to the terminal.</p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in'>This function will return the<span
style="mso-spacerun: yes">&nbsp; </span>number of characters moved.<span
style="mso-spacerun: yes">&nbsp; </span>If there are errors, it will return -1.</p>

<p class=MsoNormal style='margin-left:.25in'><o:p>&nbsp;</o:p></p>

<b style='mso-bidi-font-weight:normal'><span style='font-size:12.0pt;
mso-bidi-font-size:10.0pt;font-family:Times;mso-fareast-font-family:"Times New Roman";
mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-US;mso-fareast-language:
EN-US'><br clear=ALL style='page-break-before:always'>
</span></b>

<p class=MsoNormal style='margin-left:.25in'><b style='mso-bidi-font-weight:
normal'>function Sys_Seek (fileDesc: int, newCurrentPosition: int) returns int<o:p></o:p></b></p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in'>This function is passed the <b
style='mso-bidi-font-weight:normal'>fileDescriptor</b> of a file (which is
assumed to have been successfully opened), and a new current position.<span
style="mso-spacerun: yes">&nbsp; </span>This function sets the current position
in the file to the given value and returns the new current position.</p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoBodyTextIndent2>Setting the current position to zero causes the
next read or write to refer to the very first byte in the file.<span
style="mso-spacerun: yes">&nbsp; </span>If the file size is N bytes, setting
the position to N will cause the next write to append data to the end of the
file.</p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in'>The current position is always
between 0 and N, where N is the file's size in bytes.</p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in'>If -1 is supplied as the new
current position, the current position will be set to N (the file size in
bytes) and N will be returned.</p>

<p class=MsoNormal style='margin-left:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.5in'>It is an error to supply a <b
style='mso-bidi-font-weight:normal'>newCurrentPosition</b> that is less than -1
or greater than N.<span style="mso-spacerun: yes">&nbsp; </span>If so, -1 will
be returned.</p>

<p class=MsoNormal style='margin-left:.25in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='margin-left:.25in'><b style='mso-bidi-font-weight:
normal'>function Sys_Close (fileDesc: int)<o:p></o:p></b></p>

<p class=MsoBodyTextIndent><o:p>&nbsp;</o:p></p>

<p class=MsoBodyTextIndent style='margin-left:.5in'>This function is passed the
<b style='mso-bidi-font-weight:normal'>fileDescriptor</b> of a file, which is
assumed to be open.<span style="mso-spacerun: yes">&nbsp; </span>It closes the
file, which includes writing out any data buffered by the kernel.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><b style='mso-bidi-font-weight:normal'><o:p>&nbsp;</o:p></b></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>Asynchronous Interrupts</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>From time-to-time an asynchronous interrupt will occur.<span
style="mso-spacerun: yes">&nbsp; </span>Consider a <b style='mso-bidi-font-weight:
normal'>DiskInterrupt</b> as an example.<span style="mso-spacerun: yes">&nbsp;
</span>When this happens, an assembly routine called <b style='mso-bidi-font-weight:
normal'>DiskInterruptHandler</b> in <b style='mso-bidi-font-weight:normal'>Runtime.s</b>
will be jumped to.<span style="mso-spacerun: yes">&nbsp; </span>It begins by
saving the system registers (after all, a Disk Interrupt might occur while a
kernel routine is executing and we’ll need to return to it).<span
style="mso-spacerun: yes">&nbsp; </span>Then <b style='mso-bidi-font-weight:
normal'>DiskInterruptHandler</b> performs an “upcall” to the function named <b
style='mso-bidi-font-weight:normal'>DiskInterruptHandler</b> in <b
style='mso-bidi-font-weight:normal'>Kernel.c</b>.<span style="mso-spacerun:
yes">&nbsp; </span>Perhaps it is a little confusing to have an assembly routine
and a KPL routine with the same name, but, oh well...</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The high-level <b style='mso-bidi-font-weight:normal'>DiskInterruptHandler</b>
routine simply signals a semaphore and returns to the assembly <b
style='mso-bidi-font-weight:normal'>DiskInterruptHandler</b> routine, which
restores the system registers and returns to whatever code was
interrupted.<span style="mso-spacerun: yes">&nbsp; </span>All the time while
these routines are running, interrupts are disabled and no other interrupts can
occur.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Also note that the interrupt handler uses space on the
system stack of whichever thread was interrupted.<span style="mso-spacerun:
yes">&nbsp; </span>It might be that some unsuspecting user-level code was
running.<span style="mso-spacerun: yes">&nbsp; </span>Although the interrupt
handler will use the system stack of that thread, the thread will be
none-the-wiser.<span style="mso-spacerun: yes">&nbsp; </span>While the
interrupt handler is running, it is running as part of some more-or-less
randomly selected thread.<span style="mso-spacerun: yes">&nbsp; </span>The
interrupt handler is not a thread on its own.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>Error Exception Handling</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>When a runtime error is<span style="mso-spacerun:
yes">&nbsp; </span>detected by the CPU, the CPU performs exception processing,
which is similar to the way it processes an interrupt.<span
style="mso-spacerun: yes">&nbsp; </span>Here are the sorts of runtime errors
that can occur in the BLITZ architecture:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Illegal
Instruction<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Arithmetic
Exception<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Address
Exception<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Page
Invalid Exception<o:p></o:p></b></p>

<h5><span style='font-family:Times'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Page
Read-only Exception<o:p></o:p></span></h5>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Privileged
Instruction<o:p></o:p></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Alignment
Exception<o:p></o:p></b></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>As an example, consider what happens when an <b
style='mso-bidi-font-weight:normal'>Alignment Exception</b> occurs.<span
style="mso-spacerun: yes">&nbsp; </span>(The others are handled the same way.)</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The CPU will consult the interrupt vector in low memory (see
<b style='mso-bidi-font-weight:normal'>Runtime.s</b>) and will jump to an
assembly language routine called <b style='mso-bidi-font-weight:normal'>AlignmentExceptionHandler</b>.<span
style="mso-spacerun: yes">&nbsp; </span>The assembly routine first checks to
see if the interrupted code was executing in system mode or not.<span
style="mso-spacerun: yes">&nbsp; </span>If it was in system mode, then the
assumption is that there is a bug in the kernel, so the assembly routine prints
a message and halts execution.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>However, if the CPU was in user mode, the assumption is that
the user-level program has a bug.<span style="mso-spacerun: yes">&nbsp;
</span>The OS will need to handle that bug without itself stopping.<span
style="mso-spacerun: yes">&nbsp; </span>So the assembly <b style='mso-bidi-font-weight:
normal'>AlignmentExceptionHandler</b> routine makes an upcall to a KPL routine
with the same name.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The high-level <b style='mso-bidi-font-weight:normal'>AlignmentExceptionHandler</b>
routine simply prints a message and terminates the process.<span
style="mso-spacerun: yes">&nbsp; </span>Process termination is performed in a
routine called <b style='mso-bidi-font-weight:normal'>ProcessFinish</b>, which
is not yet written.<span style="mso-spacerun: yes">&nbsp; </span>(For now,
we’ll assume that user-level programs do not have any bugs.)</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>When <b style='mso-bidi-font-weight:normal'>ProcessFinish</b>
is implemented in a later project, it will need to return the <b
style='mso-bidi-font-weight:normal'>ProcessControlBlock</b> (PCB) to the free
pool.<span style="mso-spacerun: yes">&nbsp; </span>It will also need to free
any additional resources held by the process, such as <b style='mso-bidi-font-weight:
normal'>OpenFile</b> objects.<span style="mso-spacerun: yes">&nbsp; </span>Of
course, any open files will need to be closed first.<span style="mso-spacerun:
yes">&nbsp; </span>Finally, <b style='mso-bidi-font-weight:normal'>ProcessFinish</b>
will call <b style='mso-bidi-font-weight:normal'>ThreadFinish</b> and will not
return.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>(Note that a <b style='mso-bidi-font-weight:normal'>Thread</b>
object cannot be added back to the free thread pool by the thread that is
running.<span style="mso-spacerun: yes">&nbsp; </span>Instead, in <b
style='mso-bidi-font-weight:normal'>ThreadFinish</b> the thread is added to a
list called <b style='mso-bidi-font-weight:normal'>threadsTobeDestroyed</b>.<span
style="mso-spacerun: yes">&nbsp; </span>Later, after another thread begins
executing (in <b style='mso-bidi-font-weight:normal'>Run</b>) the first thing
it will do is add any threads on that list back to the free pool by calling <b
style='mso-bidi-font-weight:normal'>threadManager.FreeThread</b>.)</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<u><span style='font-size:14.0pt;mso-bidi-font-size:10.0pt;font-family:"Courier New";
mso-fareast-font-family:"Times New Roman";mso-bidi-font-family:"Times New Roman";
mso-ansi-language:EN-US;mso-fareast-language:EN-US'><br clear=ALL
style='page-break-before:always'>
</span></u>

<h3>Syscalls</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>When a user-level thread executes a syscall instruction, the
assembly routine <b style='mso-bidi-font-weight:normal'>SyscallTrapHandler</b>
in <b style='mso-bidi-font-weight:normal'>Runtime.s</b> will be invoked.<span
style="mso-spacerun: yes">&nbsp; </span>The assembly routine will then call a
KPL routine with the same name.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The assembly routine does not need to save registers because
the interrupted code was executing in user mode and the handler will be
executed in system mode.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Recall that just before the syscall, the <b
style='mso-bidi-font-weight:normal'>DoSyscall</b> routine placed the arguments
in the (user) registers <b style='mso-bidi-font-weight:normal'>r1</b>, <b
style='mso-bidi-font-weight:normal'>r2</b>, <b style='mso-bidi-font-weight:
normal'>r3</b>, and <b style='mso-bidi-font-weight:normal'>r4</b>, with an
integer indicating which kernel function is wanted in register <b
style='mso-bidi-font-weight:normal'>r5</b>.<span style="mso-spacerun:
yes">&nbsp; </span>The <b style='mso-bidi-font-weight:normal'>SyscallTrapHandler</b><span
style="mso-spacerun: yes">&nbsp; </span>assembly routine takes the values from
the user registers.<span style="mso-spacerun: yes">&nbsp; </span>Since it is
running in system mode, it must use a special instruction called “readu” to get
values from the user registers.<span style="mso-spacerun: yes">&nbsp; </span>It
pushes them on to the system stack so that the high-level routine can access
them.<span style="mso-spacerun: yes">&nbsp; </span>Then it calls the high-level
<b style='mso-bidi-font-weight:normal'>SyscallTrapHandler</b><span
style="mso-spacerun: yes">&nbsp; </span>routine.<span style="mso-spacerun:
yes">&nbsp; </span>When the high-level routine returns, it takes the returned
value from the stack and moves it into user register <b style='mso-bidi-font-weight:
normal'>r1</b>, using an instruction called “writeu,” and then executes a
“reti” instruction to return to the interrupted user-level process.<span
style="mso-spacerun: yes">&nbsp; </span>Execution will resume back in <b
style='mso-bidi-font-weight:normal'>DoSyscall</b> directly after the “syscall”
instruction.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The high-level routine called <b style='mso-bidi-font-weight:
normal'>SyscallTrapHandler</b> simply takes a look at the function code and
calls the appropriate routine to finish the work.<span style="mso-spacerun:
yes">&nbsp; </span>For every kind of syscall, there is a corresponding “handler
routine” in the OS.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='tab-stops:.5in 121.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'><u>System call</u></b><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'><u>Handler function in the kernel</u></b></p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Exit<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Exit</p>

<p class=MsoFooter style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Shutdown<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Shutdown</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Yield<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Yield</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Fork<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Fork</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Join<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Join</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Exec<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Exec</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Create<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Create</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Open<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Open</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Read<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Read</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Write<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Write</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Seek<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Seek</p>

<p class=MsoNormal style='tab-stops:45.0pt 130.5pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Close<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Close</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>It is these routines that you will need to implement, in
this and other projects.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Note that interrupts will be disabled when the <b
style='mso-bidi-font-weight:normal'>SyscallTrapHandler</b> routine begins.<span
style="mso-spacerun: yes">&nbsp; </span>The first thing the high-level routine
does is set the global variable <b style='mso-bidi-font-weight:normal'>currentInterruptStatus</b>
to DISABLED so that it is accurate.<span style="mso-spacerun: yes">&nbsp;
</span>In fact, all the interrupt and exception handlers begin by setting <b
style='mso-bidi-font-weight:normal'>currentInterruptStatus</b> to DISABLED for
this reason.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Also note that after the handler routines return to the
interrupted routine, interrupts will be re-enabled.<span style="mso-spacerun:
yes">&nbsp; </span>Why?<span style="mso-spacerun: yes">&nbsp; </span>Because
the Status Register in the CPU will be restored as part of the operation of the
reti instruction, restoring the interrupt (and paging and system mode) status
bits to what they were when the interrupt occurred.<span style="mso-spacerun:
yes">&nbsp; </span>(Note that we do not bother to change <b style='mso-bidi-font-weight:
normal'>currentInterruptStatus</b> to ENABLED before returning to user-level
code, because any re-entry to the kernel code must be through <b
style='mso-bidi-font-weight:normal'>SyscallTrapHandler</b>, or an interrupt or
exception handler, and each of these begins by setting <b style='mso-bidi-font-weight:
normal'>currentInterruptStatus</b>.)</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Implementing the <b style='mso-bidi-font-weight:normal'>Shutdown</b>
syscall is straightforward.<span style="mso-spacerun: yes">&nbsp; </span>The
handler should call <b style='mso-bidi-font-weight:normal'>FatalError</b> with
the following message:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Syscall
'Shutdown' was invoked by a user thread<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h3>The BLITZ Disk</h3>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The BLITZ computer includes a disk which is emulated using a
file called DISK on the host computer.<span style="mso-spacerun: yes">&nbsp;
</span>In other words, a write to the BLITZ disk will cause data to be written
to a Unix file and a read from the BLITZ disk will cause a read from the Unix
file.<span style="mso-spacerun: yes">&nbsp; </span>The emulator will simulate
the delays involved in reading, by taking account of the current (simulated)
disk head position.<span style="mso-spacerun: yes">&nbsp; </span>When the I/O
is complete&#8212;that is the simulated time when the emulator has calculated
the disk I/O will have completed&#8212;the emulator causes a <b
style='mso-bidi-font-weight:normal'>DiskInterrupt</b> to occur.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>To interface with the BLITZ disk, we have supplied a class
called <b style='mso-bidi-font-weight:normal'>DiskDriver</b>, which makes it
unnecessary for you to write the code that actually reads and writes disk
sectors.<span style="mso-spacerun: yes">&nbsp; </span>You can just use the code
in the class <b style='mso-bidi-font-weight:normal'>DiskDriver</b>.<span
style="mso-spacerun: yes">&nbsp; </span>There is only one <b style='mso-bidi-font-weight:
normal'>DiskDriver</b> object; it is created and initialized at startup time.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp; </span><u>class</u> DiskDriver<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>superclass</u> Object<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>fields<o:p></o:p></u></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>...<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>semToSignalOnCompletion: <u>ptr</u> <u>to</u> Semaphore<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>semUsedInSynchMethods: Semaphore<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>diskBusy: Mutex<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>methods<o:p></o:p></u></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Init ()<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SynchReadSector<span style="mso-spacerun: yes">&nbsp;
</span>(sectorAddr, numberOfSectors, memoryAddr: <u>int</u>)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>StartReadSector<span style="mso-spacerun: yes">&nbsp;
</span>(sectorAddr, numberOfSectors, memoryAddr: <u>int</u>,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>whoCares:
<u>ptr</u> <u>to</u> Semaphore)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SynchWriteSector (sectorAddr, numberOfSectors, memoryAddr: <u>int</u>)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>StartWriteSector (sectorAddr, numberOfSectors, memoryAddr: <u>int</u>,<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>whoCares: <u>ptr</u> <u>to</u> Semaphore)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp; </span><u>endClass<o:p></o:p></u></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>This class provides a way to read and write sectors <i
style='mso-bidi-font-style:normal'>synchronously</i> as well as a way to read
and write sectors <i style='mso-bidi-font-style:normal'>asynchronously</i>.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>To perform a disk operation without blocking the calling
thread, you can call <b style='mso-bidi-font-weight:normal'>StartReadSector</b>
or <b style='mso-bidi-font-weight:normal'>StartWriteSector</b>.<span
style="mso-spacerun: yes">&nbsp; </span>These methods are passed the number of
the sector on the disk at which to begin the transfer, the number of sectors to
transfer and the location in memory to transfer the data to or from.<span
style="mso-spacerun: yes">&nbsp; </span>These methods are also passed a pointer
to a Semaphore; upon completion of the operation (possibly in error!) this
semaphore will be signaled with an <b style='mso-bidi-font-weight:normal'>Up()</b>
operation.<span style="mso-spacerun: yes">&nbsp; </span>This is exactly the
semaphore that is signaled whenever a <b style='mso-bidi-font-weight:normal'>DiskInterrupt</b>
occurs.<span style="mso-spacerun: yes">&nbsp; </span>So to perform asynchronous
I/O, the caller will invoke <b style='mso-bidi-font-weight:normal'>StartReadSector</b>
(or <b style='mso-bidi-font-weight:normal'>StartWriteSector</b>) giving it a
Semaphore.<span style="mso-spacerun: yes">&nbsp; </span>Then the caller can
either do other stuff, or wait on the Semaphore.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Since it may be a little tricky to manage asynchronous I/O
correctly, the <b style='mso-bidi-font-weight:normal'>DiskDriver</b> class also
provides a couple of methods to make it easy to do I/O synchronously.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>When you call <b style='mso-bidi-font-weight:normal'>SynchReadSector</b>
or <b style='mso-bidi-font-weight:normal'>SynchWriteSector</b>, the caller will
be suspended and will be returned to only after a successful completion of the
I/O.<span style="mso-spacerun: yes">&nbsp; </span>These routines will deal with
transient errors by retrying the operation until it works.<span
style="mso-spacerun: yes">&nbsp; </span>Other errors (such as a bad <b
style='mso-bidi-font-weight:normal'>sectorAddr</b> or bad <b style='mso-bidi-font-weight:
normal'>memoryAddr</b>) will be dealt with by a call to <b style='mso-bidi-font-weight:
normal'>FatalError</b>.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>In order to implement these methods, the <b
style='mso-bidi-font-weight:normal'>DiskDriver</b> contains a mutex called <b
style='mso-bidi-font-weight:normal'>diskBusy</b> and a semaphore called <b
style='mso-bidi-font-weight:normal'>SemUsedInSynchMethods</b>.<span
style="mso-spacerun: yes">&nbsp; </span>Each synch method makes sure the disk
is not busy with I/O from some other thread and, if so, waits until it is
completed.<span style="mso-spacerun: yes">&nbsp; </span>This is the purpose of
the <b style='mso-bidi-font-weight:normal'>diskBusy</b> mutex.<span
style="mso-spacerun: yes">&nbsp; </span>After acquiring the lock, each synch
method will call <b style='mso-bidi-font-weight:normal'>StartReadSector</b> (or
<b style='mso-bidi-font-weight:normal'>StartWriteSector</b>) supplying the
semaphore.<span style="mso-spacerun: yes">&nbsp; </span>The synch method will
then wait until the disk operation is complete.<span style="mso-spacerun:
yes">&nbsp; </span>The calling thread will remain blocked for the duration.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h3>The “Stub” File System</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>As a later project, you might want to implement a full file
system, more like the one used by Unix systems.<span style="mso-spacerun:
yes">&nbsp; </span>For now, you are supplied with a very minimal file system,
called the “stub” file system.<span style="mso-spacerun: yes">&nbsp; </span>In
Unix, directories are structured in a tree shape and there are lots of
complexities concerning how files are stored on the disk.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>In the stub file system, the disk will contain only one
directory, and several files.<span style="mso-spacerun: yes">&nbsp; </span>The
directory is limited in size to one sector and is kept in sector 0 of the
disk.<span style="mso-spacerun: yes">&nbsp; </span>The exact number of files
that can be accommodated depends on how long the file names are.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Each file has a name and a file length (in bytes).<span
style="mso-spacerun: yes">&nbsp; </span>Each file is stored on disk in a
sequence of consecutive sectors.<span style="mso-spacerun: yes">&nbsp;
</span>Once a file is placed on the disk, and more files are added after it, it
is impossible to increase the size of the file.<span style="mso-spacerun:
yes">&nbsp; </span>Each file is allocated an integral number of sectors.<span
style="mso-spacerun: yes">&nbsp; </span>(Since the last sector in each file may
be only partially full, it would be possible to increase the size of a file up
to the next sector boundary.<span style="mso-spacerun: yes">&nbsp;
</span>However, it is not worth the effort.<span style="mso-spacerun:
yes">&nbsp; </span>Instead, the solution is to design a better file system!)</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>For now, the directory is read-only, so files may not be
created and the size of files may not be changed.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The classes <b style='mso-bidi-font-weight:normal'>FileManager</b>,
<b style='mso-bidi-font-weight:normal'>FileControlBlock</b>, and <b
style='mso-bidi-font-weight:normal'>OpenFile</b> are provided for you, to make
it easier to use the file system from within the kernel.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>The “diskUtil” Tool</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The BLITZ tool called <b style='mso-bidi-font-weight:normal'>diskUtil</b>
can be used to create a file system on the BLITZ disk, to add files to the
disk, to remove files, and to print out the directory.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The BLITZ DISK is organized as follows.<span
style="mso-spacerun: yes">&nbsp; </span>The disk contains a single directory
and this is kept in sector 0.<span style="mso-spacerun: yes">&nbsp; </span>The
files are placed sequentially on the disk, one after the other.<span
style="mso-spacerun: yes">&nbsp; </span>Each file will take up an integral
number of sectors.<span style="mso-spacerun: yes">&nbsp; </span>Each file has
an entry in the directory.<span style="mso-spacerun: yes">&nbsp; </span>Each
entry contains</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='tab-stops:.25in 45.0pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>(1)<span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp; </span>The
starting sector</p>

<p class=MsoNormal style='tab-stops:.25in 45.0pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>(2)<span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp; </span>The
file length, in bytes (possibly zero)</p>

<p class=MsoNormal style='tab-stops:.25in 45.0pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>(3)<span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp; </span>The
number of characters in the file name</p>

<p class=MsoNormal style='tab-stops:.25in 45.0pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>(4)<span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp; </span>The
file name</p>

<p class=MsoNormal style='tab-stops:.25in 45.0pt'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='tab-stops:.25in 45.0pt'>The directory begins with
three numbers:</p>

<p class=MsoNormal style='tab-stops:.25in 45.0pt'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='tab-stops:.25in 45.0pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>(1)<span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp; </span>Magic
Number (0x73747562 = “stub”)</p>

<p class=MsoNormal style='tab-stops:.25in 45.0pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>(2)<span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp; </span>Number
of files (possibly zero)</p>

<p class=MsoNormal style='tab-stops:.25in 45.0pt'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>(3)<span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp; </span>Number
of the next free sector</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>These are followed by the entries for each file.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Once created, a BLITZ file may not have its size
increased.<span style="mso-spacerun: yes">&nbsp; </span>When a file is removed,
the free sectors become unusable; there is no compaction or any attempt to
reclaim the lost space.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Each time the <b style='mso-bidi-font-weight:normal'>diskUtil</b>
program is run, it performs one of the following functions:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='tab-stops:1.25in'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b style='mso-bidi-font-weight:normal'>Initialize</b><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>set
up a new file system on the BLITZ disk</p>

<p class=MsoFooter style='tab-stops:1.25in'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b style='mso-bidi-font-weight:normal'>List</b>
<span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>list
the directory on the BLITZ disk</p>

<p class=MsoNormal style='tab-stops:1.25in'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b style='mso-bidi-font-weight:normal'>Create</b><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>create
a new file of a given size</p>

<p class=MsoNormal style='tab-stops:1.25in'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b style='mso-bidi-font-weight:normal'>Remove</b><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>remove
a file</p>

<p class=MsoNormal style='tab-stops:1.25in'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b style='mso-bidi-font-weight:normal'>Add</b><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>copy
a file from Unix to BLITZ</p>

<p class=MsoNormal style='tab-stops:1.25in'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b style='mso-bidi-font-weight:normal'>Extract</b><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>copy
a file from BLITZ to Unix</p>

<p class=MsoNormal style='tab-stops:1.25in'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b style='mso-bidi-font-weight:normal'>Write</b><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>write
sectors from a Unix file to the BLITZ disk</p>

<p class=MsoNormal style='tab-stops:1.25in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The following command line options tell which function is to
be performed by <b style='mso-bidi-font-weight:normal'>diskUtil</b>:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style="mso-spacerun: yes">&nbsp; </span>-h<o:p></o:p></b></p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Print help info.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style="mso-spacerun: yes">&nbsp; </span>-d<span style="mso-spacerun:
yes">&nbsp; </span>DiskFileName<o:p></o:p></b></p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>The file used to emulate
the BLITZ disk.<span style="mso-spacerun: yes">&nbsp; </span>If missing, “DISK”
will be used.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<b style='mso-bidi-font-weight:normal'><span style='font-size:12.0pt;
mso-bidi-font-size:10.0pt;font-family:Times;mso-fareast-font-family:"Times New Roman";
mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-US;mso-fareast-language:
EN-US'><br clear=ALL style='page-break-before:always'>
</span></b>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style="mso-spacerun: yes">&nbsp; </span>-i<o:p></o:p></b></p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Initialize the file
system on the BLITZ “DISK” file.<span style="mso-spacerun: yes">&nbsp;
</span>This will</p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>effectively remove all
files on the BLITZ disk and reclaim all available</p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>space.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style="mso-spacerun: yes">&nbsp; </span>-l<o:p></o:p></b></p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>List the directory on
the BLITZ disk.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style="mso-spacerun: yes">&nbsp; </span>-c<span style="mso-spacerun:
yes">&nbsp; </span>BlitzFileName<span style="mso-spacerun: yes">&nbsp;
</span>SizeInBytes<o:p></o:p></b></p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Create a file of the
given size on the BLITZ disk.<span style="mso-spacerun: yes">&nbsp; </span>The
BLITZ</p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>disk must not already
contain a file with this name.<span style="mso-spacerun: yes">&nbsp; </span>Only
the</p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>directory will be
modified; the actual data in the file will be</p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>whatever bytes happened
to be on the disk already.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style="mso-spacerun: yes">&nbsp; </span>-r<span style="mso-spacerun:
yes">&nbsp; </span>BlitzFileName<o:p></o:p></b></p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Remove the file with the
given name from the directory on the BLITZ disk.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style="mso-spacerun: yes">&nbsp; </span>-a<span style="mso-spacerun:
yes">&nbsp; </span>UnixFilename<span style="mso-spacerun: yes">&nbsp;
</span>BlitzFileName<o:p></o:p></b></p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Copy a file from Unix to
the BLITZ disk.<span style="mso-spacerun: yes">&nbsp; </span>If BlitzFileName
already</p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exists, it must be large
enough to accommodate the new data.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style="mso-spacerun: yes">&nbsp; </span>-e<span style="mso-spacerun:
yes">&nbsp; </span>BlitzFileName<span style="mso-spacerun: yes">&nbsp;
</span>UnixFileName<o:p></o:p></b></p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Extract a file from the
BLITZ disk to Unix.<span style="mso-spacerun: yes">&nbsp; </span>This command
will copy</p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>the data from the BLITZ
disk to a Unix file.<span style="mso-spacerun: yes">&nbsp; </span>The Unix file
may or may</p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>not already exist; its
size will be shortened or lengthened as necessary.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style="mso-spacerun: yes">&nbsp; </span>-w<span style="mso-spacerun:
yes">&nbsp; </span>UnixFileName<span style="mso-spacerun: yes">&nbsp;
</span>SectorNumber<o:p></o:p></b></p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>The UnixFileName must be
an existing Unix file. The SectorNumber is an</p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>integer.<span
style="mso-spacerun: yes">&nbsp; </span>The Unix file data will be<span
style="mso-spacerun: yes">&nbsp; </span>written to the BLITZ disk, starting</p>

<p class=MsoNormal><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>at sector
SectorNumber.<span style="mso-spacerun: yes">&nbsp; </span>The directory will
not be modified.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>We are providing a DISK file which should be large enough,
but if you want, you may create a new BLITZ disk file of a different size.<span
style="mso-spacerun: yes">&nbsp; </span>The new disk file must also be
initialized properly; it can be created and initialized with the <b
style='mso-bidi-font-weight:normal'>format</b> command in the BLITZ
emulator.<span style="mso-spacerun: yes">&nbsp; </span>For example:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='margin-left:.25in;tab-stops:.5in'><span
style='font-size:10.0pt;font-family:Courier'>% <b style='mso-bidi-font-weight:
normal'><u>blitz<o:p></o:p></u></b></span></p>

<p class=MsoFooter style='margin-left:.25in;tab-stops:.5in'><span
style='font-size:10.0pt;font-family:Courier'>...<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.25in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp; </span>&gt; <b
style='mso-bidi-font-weight:normal'><u>format</u></b><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.25in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp; </span>...<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.25in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp; </span>The name
of the disk file is &quot;DISK&quot;.<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.25in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp; </span>The file
&quot;DISK&quot; did not previously exist.<span style="mso-spacerun:
yes">&nbsp; </span>(It could not<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.25in'><span style='font-size:10.0pt;
font-family:Courier'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>be opened for reading.)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.25in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp; </span>Enter
the number of tracks (e.g., 1000; type 0 to abort):<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.25in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp; </span><b
style='mso-bidi-font-weight:normal'><u>3<o:p></o:p></u></b></span></p>

<p class=MsoNormal style='tab-stops:.25in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp; </span>...<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.25in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp; </span>Initializing
sectors 0 through 47...<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.25in'><span style='font-size:10.0pt;
font-family:Courier'><span style='mso-tab-count:1'>&nbsp;&nbsp; </span>Successful
completion.<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Next, we use <b style='mso-bidi-font-weight:normal'>diskUtil</b>
to create a file system, add several files, and print the directory, by typing
these commands at the Unix prompt:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='margin-left:.25in;tab-stops:.5in'><span
style='font-size:10.0pt;font-family:"Courier New"'>% <b style='mso-bidi-font-weight:
normal'><u>diskUtil &#8211;i</u></b><o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.25in'><span style='font-size:10.0pt;
font-family:"Courier New"'>% <b style='mso-bidi-font-weight:normal'><u>diskUtil
-a temp1 MyFileA</u></b><o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.25in'><span style='font-size:10.0pt;
font-family:"Courier New"'>% <b style='mso-bidi-font-weight:normal'><u>diskUtil
-a temp2 MyFileB</u></b><o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.25in'><span style='font-size:10.0pt;
font-family:"Courier New"'>% <b style='mso-bidi-font-weight:normal'><u>diskUtil
-a MyProgram MyProgram</u></b><o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.25in'><span style='font-size:10.0pt;
font-family:"Courier New"'>% <b style='mso-bidi-font-weight:normal'><u>diskUtil
&#8211;l</u></b><o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.25in'><span style='font-size:10.0pt;
font-family:"Courier New"'><span style="mso-spacerun: yes">&nbsp;&nbsp;
</span>StartingSector<span style="mso-spacerun: yes">&nbsp;&nbsp;
</span>SizeInSectors<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;
</span>SizeInBytes<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>FileName<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.25in'><span style='font-size:10.0pt;
font-family:"Courier New"'><span style="mso-spacerun: yes">&nbsp;&nbsp;
</span>==============<span style="mso-spacerun: yes">&nbsp;&nbsp;
</span>=============<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;
</span>===========<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;
</span>=====================<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.25in'><span style='font-size:10.0pt;
font-family:"Courier New"'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>0<span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>8192<span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>&lt; directory &gt;<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.25in'><span style='font-size:10.0pt;
font-family:"Courier New"'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>1<span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>1<span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>8192<span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>MyFileA<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.25in'><span style='font-size:10.0pt;
font-family:"Courier New"'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>2<span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>3<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>17000<span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>MyFileB<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.25in'><span style='font-size:10.0pt;
font-family:"Courier New"'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>5<span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>8<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>60264<span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>MyProgram<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h3>The FileManager</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>There is only one <b style='mso-bidi-font-weight:normal'>FileManager</b>
object; it is created and initialized at startup time.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>We are supplying several methods to help you access files on
the “stub” file system; these methods are located in this class.<span
style="mso-spacerun: yes">&nbsp; </span>You’ll need to know how to access files
in order to create the first user-level process.<span style="mso-spacerun:
yes">&nbsp; </span>You’ll need to open the executable file, read the bytes from
disk, then close the file.<span style="mso-spacerun: yes">&nbsp; </span>You’ll
also need to use the <b style='mso-bidi-font-weight:normal'>fileManager</b>
when you implement the <b style='mso-bidi-font-weight:normal'>Exec</b> syscall.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Some of the following material pertains more to the next
project than this project.<span style="mso-spacerun: yes">&nbsp; </span>Read it
all now to get familiar with the framework.<span style="mso-spacerun:
yes">&nbsp; </span>You may want to review it again during the next project.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Associated with the <b style='mso-bidi-font-weight:normal'>FileManager</b>
class, there are two other classes called <b style='mso-bidi-font-weight:normal'>FileControlBlock</b>
and <b style='mso-bidi-font-weight:normal'>OpenFile</b>.<span
style="mso-spacerun: yes">&nbsp; </span>These two classes contain fields, but
do not contain many methods of their own (besides <b style='mso-bidi-font-weight:
normal'>Init()</b> and <b style='mso-bidi-font-weight:normal'>Print()</b>
methods).<span style="mso-spacerun: yes">&nbsp; </span>Instead, most of the
work associated with the file system is done by the <b style='mso-bidi-font-weight:
normal'>FileManager</b> methods.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The <b style='mso-bidi-font-weight:normal'>FileControlBlock</b>
(<b style='mso-bidi-font-weight:normal'>FCB</b>) objects and the <b
style='mso-bidi-font-weight:normal'>OpenFile</b> objects are limited
resources.<span style="mso-spacerun: yes">&nbsp; </span>The <b
style='mso-bidi-font-weight:normal'>FileManager</b> maintains a free list for
each of these, as well as code to allocate new <b style='mso-bidi-font-weight:
normal'>FCB</b> objects and new <b style='mso-bidi-font-weight:normal'>OpenFile</b>
objects and maintain the free lists.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The <b style='mso-bidi-font-weight:normal'>FileManager</b>
also deals with opening files.<span style="mso-spacerun: yes">&nbsp;
</span>This involves finding the file in the file system, that is, determining
the file’s location on disk.<span style="mso-spacerun: yes">&nbsp; </span>In
the “stub” file system this is pretty simple since there is only one directory
and it fits into a single sector.<span style="mso-spacerun: yes">&nbsp;
</span>The <b style='mso-bidi-font-weight:normal'>FileManager</b>&#8212;as
programmed now&#8212;reads the directory sector (sector 0) into a frame as part
of the <b style='mso-bidi-font-weight:normal'>FileManager.Init</b> method.<span
style="mso-spacerun: yes">&nbsp; </span>Subsequent attempts to open a file
require no disk accesses.<span style="mso-spacerun: yes">&nbsp; </span>(Of
course, for a “real” file system, things won’t be so simple!)</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h3>FileControlBlock (FCB) and OpenFile</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The semantics of files in the kernel you are building will
be similar to the semantics of files in Unix.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Consider the case where one process has opened a file and
does a kernel call to read, say, 10 bytes.<span style="mso-spacerun:
yes">&nbsp; </span>The kernel must read the appropriate sector, extract the 10
bytes out of that sector, and finally copy those 10 bytes into the process’s
virtual memory space.<span style="mso-spacerun: yes">&nbsp; </span>This
requires the kernel to maintain a frame of memory to use as a buffer; the
sector will be read into this buffer by the OS.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>If the 10 bytes happen to span the boundary between sectors,
the kernel must read both sectors in order to complete the <b style='mso-bidi-font-weight:
normal'>Read</b> syscall.<span style="mso-spacerun: yes">&nbsp; </span>And of
course, during the I/O operations other threads must be allowed to run.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Now consider what happens when a process wants to write,
say, 20 bytes to a file.<span style="mso-spacerun: yes">&nbsp; </span>The
kernel will need to bring in the appropriate sector and copy the 20 bytes from
the process’s virtual address space to the buffer.<span style="mso-spacerun:
yes">&nbsp; </span>Should the kernel write the buffer back to disk
immediately?<span style="mso-spacerun: yes">&nbsp; </span>No; it is likely that
the process will want to write some more bytes to that very same sector, so it
is more efficient to leave the sector in memory.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>When should the kernel write the sector back to disk?<span
style="mso-spacerun: yes">&nbsp; </span>When the process closes the file, the
kernel must write it back.<span style="mso-spacerun: yes">&nbsp; </span>Also,
other I/O operations on the file may need different sectors, so the kernel
should write the sector back to disk when the buffer is needed for another
sector.<span style="mso-spacerun: yes">&nbsp; </span>However, if the buffer has
not been modified, then there is no need to write it back to the disk.<span
style="mso-spacerun: yes">&nbsp; </span>Therefore, we associate a Boolean
called <b style='mso-bidi-font-weight:normal'>bufferIsDirty</b> with each
buffer frame.<span style="mso-spacerun: yes">&nbsp; </span>When a buffer is
first read in from disk, it is considered to be “clean,” but after any
operation modifies the buffer, it should be marked “dirty.”</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Next consider the case in which two processes have both
opened the same file.<span style="mso-spacerun: yes">&nbsp; </span>(Let’s call
them processes “A” and “B.”)<span style="mso-spacerun: yes">&nbsp; </span>Any
update by process A must be immediately visible to process B.<span
style="mso-spacerun: yes">&nbsp; </span>If process A writes to a file and B
reads from that same file, even before A has closed the file, then B should see
the new data.<span style="mso-spacerun: yes">&nbsp; </span>Since the kernel may
not actually write to the disk for a long time after process A does the write,
it means that processes A and B must share the buffer.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Also, when one process finally closes a file, the buffer
must be written back to the disk.<span style="mso-spacerun: yes">&nbsp;
</span>The guarantee the kernel makes is that once we return from a call to <b
style='mso-bidi-font-weight:normal'>Sys_Close</b>, the disk has been
updated.<span style="mso-spacerun: yes">&nbsp; </span>The program can stop
worrying about failures, etc., and can tell the user that it has completed its
task.<span style="mso-spacerun: yes">&nbsp; </span>Any changes the program has
made&#8212;even if the system crashes in the next instance&#8212;will be permanent
and will not be lost.<span style="mso-spacerun: yes">&nbsp; </span>After a <b
style='mso-bidi-font-weight:normal'>Sys_Close</b>, the kernel must not return
to the user-level program until the buffer (or all buffers, if there are more
than one) is written to the disk successfully.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The purpose of a <b style='mso-bidi-font-weight:normal'>FileControlBlock</b>
(FCB) is to record all the data associated with a single file.<span
style="mso-spacerun: yes">&nbsp; </span>This includes the buffer and the <b
style='mso-bidi-font-weight:normal'>bufferIsDirty</b> bit.<span
style="mso-spacerun: yes">&nbsp; </span>Here is the definition of FCB:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<b style='mso-bidi-font-weight:normal'><span style='font-size:12.0pt;
mso-bidi-font-size:10.0pt;font-family:"Courier New";mso-fareast-font-family:
"Times New Roman";mso-bidi-font-family:"Times New Roman";mso-ansi-language:
EN-US;mso-fareast-language:EN-US'><br clear=ALL style='page-break-before:always'>
</span></b>

<p class=MsoNormal><u><span style='font-size:10.0pt;font-family:Courier'>class</span></u><span
style='font-size:10.0pt;font-family:Courier'> FileControlBlock<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>superclass</u> Listable<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.5in'><span style='font-size:10.0pt;
font-family:Courier'><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>fields<o:p></o:p></u></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>fcbID: <u>int</u><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>numberOfUsers: <u>int</u><span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>-- count of OpenFiles pointing here<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>startingSectorOfFile: <u>int</u><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>-- or -1 if FCB not in use<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>sizeOfFileInBytes: <u>int</u><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>bufferPtr: <u>int</u><span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>-- addr of a page frame<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>relativeSectorInBuffer: <u>int</u><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp; </span>-- or -1 if none<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>bufferIsDirty: <u>bool</u><span
style="mso-spacerun: yes">&nbsp;&nbsp; </span><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-- Set to
true when buffer is modified<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>methods<o:p></o:p></u></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Init ()<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Print ()<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>endClass<o:p></o:p></u></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>A small number FCBs are preallocated
and kept in a table called <b style='mso-bidi-font-weight:normal'>fcbTable</b>,
which is maintained by the <b style='mso-bidi-font-weight:normal'>FileManager</b>.<span
style="mso-spacerun: yes">&nbsp; </span>The <b style='mso-bidi-font-weight:
normal'>FileManager</b> is responsible for allocating new <b style='mso-bidi-font-weight:
normal'>FileControlBlock</b> objects and for returning unused <b
style='mso-bidi-font-weight:normal'>FileControlBlock</b> objects to a free pool
called <b style='mso-bidi-font-weight:normal'>fcbFreeList</b>.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>The <b style='mso-bidi-font-weight:
normal'>startingSectorOfFile</b> tells where the file is located on the
disk.<span style="mso-spacerun: yes">&nbsp; </span>Since all the sectors in a
file are contiguous, the starting address and the length are all we need.<span
style="mso-spacerun: yes">&nbsp; </span>The meaning of <b style='mso-bidi-font-weight:
normal'>sizeOfFileInBytes</b> is... well, obvious.<span style="mso-spacerun:
yes">&nbsp; </span>[Descriptive variable names like we tend to use are a HUGE
help in understanding and reading code!]<span style="mso-spacerun: yes">&nbsp;
</span>A single memory frame is allocated for each FCB at kernel startup time
and <b style='mso-bidi-font-weight:normal'>bufferPtr</b> is set to point to
that memory region.<span style="mso-spacerun: yes">&nbsp; </span><b
style='mso-bidi-font-weight:normal'>relativeSectorInBuffer</b> tells which
sector of the file is currently in the buffer and is &#8211;1 if there is no
valid data in the buffer.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>Next consider a process “A” that has
opened a file.<span style="mso-spacerun: yes">&nbsp; </span>All of the “read”
and “write” operations that the user-level process executes are relative to a
“current position” in the file.<span style="mso-spacerun: yes">&nbsp;
</span>Several processes may have the same file open.<span style="mso-spacerun:
yes">&nbsp; </span>All processes that have file “F” open will share a single
FCB.<span style="mso-spacerun: yes">&nbsp; </span>However, they will each have
a different “current position” in the file.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>To handle the current position, we
have the class <b style='mso-bidi-font-weight:normal'>OpenFile</b>, which is
defined as:</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp; </span><u>class</u> OpenFile<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>superclass</u> Listable<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>fields<o:p></o:p></u></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>kind: <u>int</u><span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>-- FILE, TERMINAL, or PIPE<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:
yes">&nbsp;&nbsp;</span>currentPos: <u>int</u><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>-- 0 = first byte of file<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>fcb: <u>ptr</u>
<u>to</u> FileControlBlock<span style="mso-spacerun: yes">&nbsp;&nbsp;
</span>-- null = not open<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>numberOfUsers: <u>int</u><span
style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>-- count of Processes pointing here<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>methods<o:p></o:p></u></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Print ()<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ReadBytes
(targetAddr, numBytes: <u>int</u>) <u>returns</u> <u>bool</u><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>--
true=All Okay<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ReadInt () <u>returns</u>
<u>int</u><o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>LoadExecutable
(addrSpace: <u>ptr</u> <u>to</u> AddrSpace) <u>returns</u> <u>int</u><span
style="mso-spacerun: yes">&nbsp; </span>-- -1 = problems<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp; </span><u>endClass<o:p></o:p></u></span></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>Like the FCBs, there is a
preallocated pool of <b style='mso-bidi-font-weight:normal'>OpenFile</b>
objects, which are created at system startup time.<span style="mso-spacerun:
yes">&nbsp; </span>The <b style='mso-bidi-font-weight:normal'>FileManager</b>
is responsible for allocating new <b style='mso-bidi-font-weight:normal'>OpenFile</b>
objects and for returning unused <b style='mso-bidi-font-weight:normal'>OpenFile</b>
objects to a free pool called <b style='mso-bidi-font-weight:normal'>openFileFreeList</b>.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>When process “A” opens a file, a new <b
style='mso-bidi-font-weight:normal'>OpenFile</b> object must be allocated and
made to point to an FCB describing the file.<span style="mso-spacerun:
yes">&nbsp; </span>If there is already an FCB for that file, then the <b
style='mso-bidi-font-weight:normal'>OpenFile</b> should be made to point to it;
otherwise, we’ll have to get a new FCB, check the directory, and set up the
FCB.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>When do we return an FCB to the free
pool?<span style="mso-spacerun: yes">&nbsp; </span>When there are no more <b
style='mso-bidi-font-weight:normal'>OpenFiles</b> using it.<span
style="mso-spacerun: yes">&nbsp; </span>This is the reason we have a field
called <b style='mso-bidi-font-weight:normal'>numberOfUsers</b> in the
FCB.<span style="mso-spacerun: yes">&nbsp; </span>This field is a “reference
counter.”<span style="mso-spacerun: yes">&nbsp; </span>It tells the number of <b
style='mso-bidi-font-weight:normal'>OpenFile</b> objects that point to the
FCB.<span style="mso-spacerun: yes">&nbsp; </span>When a new <b
style='mso-bidi-font-weight:normal'>OpenFile</b> is allocated and made to point
to an FCB, the count must be incremented.<span style="mso-spacerun: yes">&nbsp;
</span>When an <b style='mso-bidi-font-weight:normal'>OpenFile</b> is closed,
the count should be decremented.<span style="mso-spacerun: yes">&nbsp;
</span>When the count becomes zero, the FCB must be returned to the free pool.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>When a process is terminated, for
example due to an error such as an <b style='mso-bidi-font-weight:normal'>AlignmentException</b>,
the kernel must close any and all <b style='mso-bidi-font-weight:normal'>OpenFiles</b>
the process is using.<span style="mso-spacerun: yes">&nbsp; </span>The process
may explicitly close an <b style='mso-bidi-font-weight:normal'>OpenFile</b>
with the <b style='mso-bidi-font-weight:normal'>Close</b> syscall.<span
style="mso-spacerun: yes">&nbsp; </span>Once a file is closed, the process
should attempt no further I/O on the file and if the process does, the kernel
should catch it and treat it as an error (by returning an error code from the <b
style='mso-bidi-font-weight:normal'>Sys_Read</b> or <b style='mso-bidi-font-weight:
normal'>Sys_Write</b> kernel call).</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>Our file I/O will follow the
semantics of Unix.<span style="mso-spacerun: yes">&nbsp; </span>When a process
is cloned with the <b style='mso-bidi-font-weight:normal'>Fork</b> syscall, all
open files in the parent process must be shared with the child process.<span
style="mso-spacerun: yes">&nbsp; </span>Consider what happens when a parent and
a child are both writing to the same file, which was originally opened in the
parent.<span style="mso-spacerun: yes">&nbsp; </span>Since both processes share
the <b style='mso-bidi-font-weight:normal'>OpenFile</b> object, they will share
the current position.<span style="mso-spacerun: yes">&nbsp; </span>If the child
writes 5 bytes, the current position will be incremented by 5.<span
style="mso-spacerun: yes">&nbsp; </span>Then, if the parent writes 13 bytes,
these 13 bytes will follow the 5 bytes written by the child.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>In order to implement these
semantics, it will be possible for several PCBs to point to the same <b
style='mso-bidi-font-weight:normal'>OpenFile</b> object.<span
style="mso-spacerun: yes">&nbsp; </span>We need to maintain a reference count
for the <b style='mso-bidi-font-weight:normal'>OpenFiles</b>, just like the
reference count for the FCBs.<span style="mso-spacerun: yes">&nbsp;
</span>Whenever a process opens a file, we need to allocate a new <b
style='mso-bidi-font-weight:normal'>OpenFile</b> object and set its count to
1.<span style="mso-spacerun: yes">&nbsp; </span>Whenever a process forks, we’ll
need to increment the count.<span style="mso-spacerun: yes">&nbsp; </span>When
a process closes a file (either by invoking the <b style='mso-bidi-font-weight:
normal'>Close</b> syscall or by dying), we’ll need to decrement the count.<span
style="mso-spacerun: yes">&nbsp; </span>If the count goes to zero, we’ll need
to return the <b style='mso-bidi-font-weight:normal'>OpenFile</b> to the free
pool and decrement the count associated with the FCB.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>User-level processes must not be
allowed to use pointers into kernel memory and cannot be allowed to touch
kernel data structures such as <b style='mso-bidi-font-weight:normal'>OpenFiles</b>
and <b style='mso-bidi-font-weight:normal'>FCBs</b>.<span style="mso-spacerun:
yes">&nbsp; </span>So how does a user process refer to an <b style='mso-bidi-font-weight:
normal'>OpenFile</b> object?<span style="mso-spacerun: yes">&nbsp;
</span>Indirectly, through an integer.<span style="mso-spacerun: yes">&nbsp;
</span>Here’s how it works.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>Each <b style='mso-bidi-font-weight:
normal'>Process</b> will have a small array of pointers to <b style='mso-bidi-font-weight:
normal'>OpenFiles</b> called <b style='mso-bidi-font-weight:normal'>fileDescriptor</b>.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp; </span><u>class</u> ProcessControlBlock<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>...<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>fields<o:p></o:p></u></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>...<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>fileDescriptor:
<u>array</u> [MAX_FILES_PER_PROCESS] <u>of</u> <u>ptr</u> <u>to</u> OpenFile<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span><u>methods<o:p></o:p></u></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>...<o:p></o:p></span></p>

<p class=MsoFooter><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp; </span><u>endClass<o:p></o:p></u></span></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>When a process invokes the <b
style='mso-bidi-font-weight:normal'>Open</b> syscall, a new <b
style='mso-bidi-font-weight:normal'>OpenFile</b> will be set up.<span
style="mso-spacerun: yes">&nbsp; </span>Then the kernel will select an unused
position in this array and make it point to the <b style='mso-bidi-font-weight:
normal'>OpenFile</b>.<span style="mso-spacerun: yes">&nbsp; </span>For example,
positions 0, 1, and 2 might be in use, so the kernel may assign a file
descriptor of 3 for the newly opened file.<span style="mso-spacerun:
yes">&nbsp; </span>The kernel must make <b style='mso-bidi-font-weight:normal'>fileDescriptor[3]</b>
point to the <b style='mso-bidi-font-weight:normal'>OpenFile</b> and should
return “3” as the <b style='mso-bidi-font-weight:normal'>fileDescriptor</b> to
the user-level process.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>When the user-level process wants to
do an I/O operation, such as <b style='mso-bidi-font-weight:normal'>Read</b>, <b
style='mso-bidi-font-weight:normal'>Write</b>, <b style='mso-bidi-font-weight:
normal'>Seek</b>, or <b style='mso-bidi-font-weight:normal'>Close</b>, it must
supply the <b style='mso-bidi-font-weight:normal'>fileDescriptor</b>.<span
style="mso-spacerun: yes">&nbsp; </span>The kernel must check that (1) this
number is a valid index into the array, and (2) the array element points to a
valid <b style='mso-bidi-font-weight:normal'>OpenFile</b>.<span
style="mso-spacerun: yes">&nbsp; </span>When closing the file, the kernel will
need to decrement the reference count for the <b style='mso-bidi-font-weight:
normal'>OpenFile</b> object and also set <b style='mso-bidi-font-weight:normal'>fileDescriptor[3]</b>
to null.<span style="mso-spacerun: yes">&nbsp; </span>Then, if the user process
attempts any future I/O operations with file descriptor 3, the kernel can
detect that it is an error.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>Since user-level file I/O will not be
implemented in this project, you will not need to worry about <b
style='mso-bidi-font-weight:normal'>fileDescriptors</b> yet.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>When a user-level program does a <b
style='mso-bidi-font-weight:normal'>Read</b> or <b style='mso-bidi-font-weight:
normal'>Write</b> syscall&#8212;in Unix or in our OS&#8212;the data may be
transferred from/to either</p>

<p class=MsoFooter style='tab-stops:.5in'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;a
file on the disk</p>

<p class=MsoFooter style='tab-stops:.5in'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;an
I/O device such as a keyboard or display (these are called “special files” in
Unix)</p>

<p class=MsoFooter style='tab-stops:.5in'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;another
process, via a “pipe”</p>

<p class=MsoFooter style='tab-stops:.5in'>In all three cases, an <b
style='mso-bidi-font-weight:normal'>OpenFile</b> object will be used.<span
style="mso-spacerun: yes">&nbsp; </span>The field called <b style='mso-bidi-font-weight:
normal'>kind</b> tells whether the object corresponds to a <b style='mso-bidi-font-weight:
normal'>FILE</b>, the <b style='mso-bidi-font-weight:normal'>TERMINAL</b>, or a
<b style='mso-bidi-font-weight:normal'>PIPE</b>.<span style="mso-spacerun:
yes">&nbsp; </span>In this project, we will only use <b style='mso-bidi-font-weight:
normal'>OpenFiles</b> to perform the <b style='mso-bidi-font-weight:normal'>Exec</b>
syscall, so the kind will be only <b style='mso-bidi-font-weight:normal'>FILE</b>
(and not <b style='mso-bidi-font-weight:normal'>TERMINAL</b> or <b
style='mso-bidi-font-weight:normal'>PIPE</b>).</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>To Read in an Executable File</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>To read in an executable file from disk, your code will need
to:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;Open
the file</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;Invoke
<b style='mso-bidi-font-weight:normal'>LoadExecutable</b> to do the work</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;Close
the file</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Read through the code for <b style='mso-bidi-font-weight:
normal'>FileManager.Open</b>:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><u>method</u>
Open (filename: String) <u>returns</u> <u>ptr</u> <u>to</u> OpenFile<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'>Open</b> is passed a <b
style='mso-bidi-font-weight:normal'>ptr to array of char</b>; this is the name
of the file on the BLITZ disk that you want to read from.<span
style="mso-spacerun: yes">&nbsp; </span>It will allocate a new <b
style='mso-bidi-font-weight:normal'>OpenFile</b> object and a new <b
style='mso-bidi-font-weight:normal'>FCB</b> object and set them up.<span
style="mso-spacerun: yes">&nbsp; </span>Then it will return a pointer to the <b
style='mso-bidi-font-weight:normal'>OpenFile</b> object, which you’ll use when
calling <b style='mso-bidi-font-weight:normal'>LoadExecutable</b>.<span
style="mso-spacerun: yes">&nbsp; </span>If anything goes wrong, <b
style='mso-bidi-font-weight:normal'>Open</b> returns <b style='mso-bidi-font-weight:
normal'>null</b>.<span style="mso-spacerun: yes">&nbsp; </span>The only real
danger is getting the filename wrong.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>In BLITZ, like Unix, executable files have rather complex
format.<span style="mso-spacerun: yes">&nbsp; </span>For details, you can read
through the document titled “<i style='mso-bidi-font-style:normal'>The Format
of BLITZ Object and Executable Files</i>.”<span style="mso-spacerun:
yes">&nbsp; </span>So that you don’t have to write all this code, we are
providing a method called <b style='mso-bidi-font-weight:normal'>OpenFile.LoadExecutable</b>:</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><u><span
style='font-size:10.0pt;font-family:Courier'>method</span></u><span
style='font-size:10.0pt;font-family:Courier'> LoadExecutable (addrSpace: <u>ptr</u>
<u>to</u> AddrSpace) <u>returns</u> <u>int</u><o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Look through <b style='mso-bidi-font-weight:normal'>LoadExecutable</b>;
it will</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;Create
a new address space (by calling <b style='mso-bidi-font-weight:normal'>frameManager.GetNewFrames</b>)</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;Read
the executable program into the new address space</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;Determine
the starting address (the initial program counter, also called the “entry
point”)</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;Return
the entry point</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>If there are any problems with the
executable file, this method will return &#8211;1.<span style="mso-spacerun:
yes">&nbsp; </span>Otherwise it will return the entry point of the
executable.<span style="mso-spacerun: yes">&nbsp; </span>This is the address
(in the logical address space) at which execution should begin.<span
style="mso-spacerun: yes">&nbsp; </span>Normally, this will be 0x00000000.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>User-Level Processes</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Each user-level process will have a single thread which will
normally execute in User mode, with “paging” turned on and interrupts enabled.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Each user-level process will have a logical address space,
which will consist of</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;A
Page for “environment” data</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;Pages
for the text segment</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;Pages
for the data segment</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;Pages
for the BSS segment</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;Pages
for the user’s stack</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>These are shown in order, with the stack pages in the
highest addresses of the logical address space.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The environment page will sit at address 0 and will contain
information that the OS wishes to pass to a new user-level process.<span
style="mso-spacerun: yes">&nbsp; </span>This includes userID, working
directory, etc.<span style="mso-spacerun: yes">&nbsp; </span>We will not use an
environment page, so the text pages will begin at address 0.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'>Kernel.h</b> contains
this:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>const<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp; </span>NUMBER_OF_ENVIRONMENT_PAGES = 0<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp; </span>USER_STACK_SIZE_IN_PAGES = 1<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp; </span>MAX_PAGES_PER_VIRT_SPACE = 20<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The text pages contain the program and any constant values.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The data pages will contain the static (global) program
variables.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The BSS pages will contain space for uninitialized program
variables (such as large arrays).<span style="mso-spacerun: yes">&nbsp;
</span>The OS will set all bytes in the BSS pages to zero.<span
style="mso-spacerun: yes">&nbsp; </span>Most KPL programs do not use a BSS
segment, so there will usually be zero BSS pages.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The user-level program will have a stack, which will grow
downward.<span style="mso-spacerun: yes">&nbsp; </span>Each logical address
space will have a predetermined small number of pages (in our case, this is one
page) set aside for its stack.<span style="mso-spacerun: yes">&nbsp; </span>In
Unix, if a user process’s stack grows beyond its initial allocation, more stack
pages would be added.<span style="mso-spacerun: yes">&nbsp; </span>In our OS,
if a user process’s stack grows beyond this, it will begin overwriting the BSS
and data pages, and the program will probably get an error of some sort soon
thereafter.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>As an example, a program might use:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>0
environment pages</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>2
text pages</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>1
data page</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>0
BSS pages</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>1
stack page</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>This process’s logical address space will have 4 pages.<span
style="mso-spacerun: yes">&nbsp; </span>Each page has PAGE_SIZE bytes (8
Kbytes), so the entire address space will be 32 Kbytes.<span
style="mso-spacerun: yes">&nbsp; </span>Any address between 0x00000000 and
0x00007FFF (which is 32K-1 in hex) would be legal for this program.<span
style="mso-spacerun: yes">&nbsp; </span>If the program tries to use any other address,
a PageInvalid Exception will occur.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>In Unix, the environment and text pages would be marked
read-only and any attempt to update bytes in those pages would cause an
exception.<span style="mso-spacerun: yes">&nbsp; </span>In this project, all
pages of the logical address space will be read-write, so our OS will not be
able to catch that sort of error in the user-level program.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Each page in the logical address space will be stored in one
frame in memory.<span style="mso-spacerun: yes">&nbsp; </span>The frames do not
have to be contiguous and the pages may be stored in pretty much any order.<span
style="mso-spacerun: yes">&nbsp; </span>However, all pages will be in memory
throughout the process’s lifetime.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The page table will keep track of where each page is
kept.<span style="mso-spacerun: yes">&nbsp; </span>While the process is
executing, “paging” will be turned on so that the memory management unit (MMU)
will translate all logical addresses into physical addresses.<span
style="mso-spacerun: yes">&nbsp; </span>Our example program will not be able to
read or write anything outside of its 4 pages.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>There may be several processes in the system at any
time.<span style="mso-spacerun: yes">&nbsp; </span>Each <b style='mso-bidi-font-weight:
normal'>ProcessControlBlock</b> contains an <b style='mso-bidi-font-weight:
normal'>AddrSpace</b>, which tells how many pages the process’s address space
has and which frame in physical memory holds each page.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>When some process (call it “P”) is ready to be scheduled and
given a time-slice, the MMU will be need to be set up so that it points to the
page table for process P.<span style="mso-spacerun: yes">&nbsp; </span>You can
do this with the method:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>AddrSpace.SetToThisPageTable
()<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>which calls an assembly routine to load the MMU
registers.<span style="mso-spacerun: yes">&nbsp; </span>This method must be
invoked before paging is turned on.<span style="mso-spacerun: yes">&nbsp;
</span>When paging is turned off (i.e., whenever kernel code is being executed),
the MMU registers are ignored.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Note that each thread will have two stacks: a user stack and
a system stack.<span style="mso-spacerun: yes">&nbsp; </span>We have already
seen the system stack; it is used when one kernel function calls another kernel
function.<span style="mso-spacerun: yes">&nbsp; </span>The user stack will be
used when the thread is running in user mode.<span style="mso-spacerun:
yes">&nbsp; </span>The system stack, which is fairly small, normally contains
nothing while the user-level program is running.<span style="mso-spacerun:
yes">&nbsp; </span>In other words, the system stack is completely empty.<span
style="mso-spacerun: yes">&nbsp; </span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>After the user-level program begins executing, execution can
re-enter the kernel in only through exception processing.<span
style="mso-spacerun: yes">&nbsp; </span>That is, the only ways to get back into
the kernel are:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;an
interrupt,</p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;a
program exception, or<span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>

<p class=MsoNormal><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>•&nbsp;a
syscall</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>In each of these cases, the exact same thing happens: some
information is pushed onto the system stack, the mode is changed to system
mode, paging is turned off, and a jump is made to a kernel “handler” routine.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The BLITZ computer has two sets of registers: one for
user-mode code and one for system-mode code.<span style="mso-spacerun:
yes">&nbsp; </span>Thus, the user registers do not need to be saved, unless the
kernel will switch to another thread.<span style="mso-spacerun: yes">&nbsp;
</span>This is done in the <b style='mso-bidi-font-weight:normal'>Run</b>
method, which contains this code:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><u>if</u>
prevThread.isUserThread<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SaveUserRegs (&amp;prevThread.userRegs[0])<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><u>endIf<o:p></o:p></u></span></p>

<p class=MsoBodyText3><span style='font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>...<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Switch
(prevThread, nextThread)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>...<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><u>if</u>
currentThread.isUserThread<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>RestoreUserRegs (&amp;currentThread.userRegs[0])<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>currentThread.myProcess.addrSpace.SetToThisPageTable ()<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><u>endIf<o:p></o:p></u></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>If the kernel handler code wishes to
return to the same user-level code that was interrupted, it can merely return
to the assembly language handler routine, which will perform a “reti”
instruction.<span style="mso-spacerun: yes">&nbsp; </span>The user registers
and the MMU registers will (presumably) be unchanged, so when the mode reverts
to “user mode” and the paging reverts to “paging enabled,” the user-level
program will resume execution with the same values in the user registers and
the same logical address space.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<h3>Creating a User-Level Process</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The <b style='mso-bidi-font-weight:normal'>main</b> function
calls function <b style='mso-bidi-font-weight:normal'>InitFirstProcess</b>,
which you must implement.<span style="mso-spacerun: yes">&nbsp; </span>The
first thing you’ll need to do is get a new thread object by invoking <b
style='mso-bidi-font-weight:normal'>GetANewThread</b>.<span
style="mso-spacerun: yes">&nbsp; </span>Since the <b style='mso-bidi-font-weight:
normal'>InitFirstProcess</b> function should return, you cannot use the current
thread.<span style="mso-spacerun: yes">&nbsp; </span>Next you’ll need to
initialize the thread and invoke <b style='mso-bidi-font-weight:normal'>Fork</b>
to start it running.<span style="mso-spacerun: yes">&nbsp; </span>(You can name
this new thread something like “UserProgram,” but the name is only used in the
debugging printouts.)</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The new thread should execute the <b style='mso-bidi-font-weight:
normal'>StartUserProcess</b> function, which will do the remainder of the work
in starting up a user-level process.<span style="mso-spacerun: yes">&nbsp;
</span><b style='mso-bidi-font-weight:normal'>InitFirstProcess</b> can supply a
zero as an argument to <b style='mso-bidi-font-weight:normal'>StartUserProcess</b>
and can return after forking the new thread.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The first thing you’ll need to do in <b style='mso-bidi-font-weight:
normal'>StartUserProcess</b> is allocate a new PCB (with <b style='mso-bidi-font-weight:
normal'>GetANewProcess</b>) and connect it with the thread.<span
style="mso-spacerun: yes">&nbsp; </span>So initialize the <b style='mso-bidi-font-weight:
normal'>myThread</b> field in the PCB and the <b style='mso-bidi-font-weight:
normal'>myProcess</b> field in the current thread.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Next, you’ll need to open the executable file.<span
style="mso-spacerun: yes">&nbsp; </span>It is acceptable to “hardcode” the
filename (e.g., “TestProgram1”) into the call to <b style='mso-bidi-font-weight:
normal'>Open</b>, although changing the name of the initial process will
require a recompile of the kernel.<span style="mso-spacerun: yes">&nbsp;
</span>If there are problems with the <b style='mso-bidi-font-weight:normal'>Open</b>,
this is a fatal, unrecoverable error and the kernel startup process will fail.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Next, you’ll need to create the logical address space and
read the executable into it.<span style="mso-spacerun: yes">&nbsp; </span>The
method <b style='mso-bidi-font-weight:normal'>OpenFile.LoadExecutable</b> will
take care of both tasks.<span style="mso-spacerun: yes">&nbsp; </span>If this
fails, the kernel cannot start up.<span style="mso-spacerun: yes">&nbsp;
</span><b style='mso-bidi-font-weight:normal'>LoadExecutable</b> returns the
entry point, which you might call <b style='mso-bidi-font-weight:normal'>initPC</b>.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Don’t forget to close the executable file you opened
earlier, or else a system resource will be permanently locked up.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Next, you’ll need to compute the initial value for the
user-level stack, which you might call <b style='mso-bidi-font-weight:normal'>InitUserStackTop</b>.<span
style="mso-spacerun: yes">&nbsp; </span>It should be set to the logical address
just past the end of the logical address space, since the initial push onto the
user stack will first decrement the top pointer.<span style="mso-spacerun:
yes">&nbsp; </span>The logical address space starts at zero.<span
style="mso-spacerun: yes">&nbsp; </span>The logical address space contains</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>addrSpace.numberOfPages<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>pages.<span style="mso-spacerun: yes">&nbsp; </span>Each
page has size <b style='mso-bidi-font-weight:normal'>PAGE_SIZE</b> bytes.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The <b style='mso-bidi-font-weight:normal'>StartUserProcess</b>
function will end by jumping into the user-level program.<span
style="mso-spacerun: yes">&nbsp; </span>This is a one way jump; execution will
never return.<span style="mso-spacerun: yes">&nbsp; </span>(Instead, if the
user-level program needs to re-enter the kernel, it will execute a
syscall).<span style="mso-spacerun: yes">&nbsp; </span>As such, nothing on the
system stack will ever be needed again.<span style="mso-spacerun: yes">&nbsp;
</span>We want to have a full-sized system stack available for processing any
syscalls or interrupts that happen later, so you need to reset the system stack
top pointer, effectively clearing the system stack.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>You might call the new value <b style='mso-bidi-font-weight:
normal'>initSystemStackTop</b>.<span style="mso-spacerun: yes">&nbsp;
</span>You’ll need to set it to:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Courier'><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>&amp;
currentThread.systemStack[SYSTEM_STACK_SIZE-1]<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<span style='font-size:12.0pt;mso-bidi-font-size:10.0pt;font-family:Times;
mso-fareast-font-family:"Times New Roman";mso-bidi-font-family:"Times New Roman";
mso-ansi-language:EN-US;mso-fareast-language:EN-US'><br clear=ALL
style='page-break-before:always'>
</span>

<p class=MsoNormal>Next, you’ll need to turn this thread into a user-level
thread.<span style="mso-spacerun: yes">&nbsp; </span>This involves these
actions:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='tab-stops:.25in .5in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>1.<span style='mso-tab-count:1'>&nbsp;&nbsp; </span>Disable
interrupts</p>

<p class=MsoNormal style='tab-stops:.25in .5in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>2.<span style='mso-tab-count:1'>&nbsp;&nbsp; </span>Initialize
the page table registers for this logical address space</p>

<p class=MsoNormal style='tab-stops:.25in .5in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>3.<span style='mso-tab-count:1'>&nbsp;&nbsp; </span>Set
the <b style='mso-bidi-font-weight:normal'>isUserThread</b> variable in the
current thread to true</p>

<p class=MsoNormal style='tab-stops:.25in .5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='tab-stops:.25in .5in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>4.<span style='mso-tab-count:1'>&nbsp;&nbsp; </span>Set
system register r15, the system stack top</p>

<p class=MsoNormal style='tab-stops:.25in .5in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>5.<span style='mso-tab-count:1'>&nbsp;&nbsp; </span>Set
user register r15, the user stack top</p>

<p class=MsoNormal style='tab-stops:.25in .5in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>6.<span style='mso-tab-count:1'>&nbsp;&nbsp; </span>Clear
the System mode bit in the condition code register to switch into user mode</p>

<p class=MsoFooter style='tab-stops:.25in .5in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>7.<span style='mso-tab-count:1'>&nbsp;&nbsp; </span>Set
the Paging bit in the cond. code register, causing the MMU to do virtual memory
mapping</p>

<p class=MsoNormal style='tab-stops:.25in .5in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>8.<span style='mso-tab-count:1'>&nbsp;&nbsp; </span>Set
the Interrupts Enabled bit in the cond. code register, so that future
interrupts will be handled</p>

<p class=MsoNormal style='tab-stops:.25in .5in'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>9.<span style='mso-tab-count:1'>&nbsp;&nbsp; </span>Jump
to the initial entry point in the program</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Recall that every thread begins life with interrupts
enabled, so your <b style='mso-bidi-font-weight:normal'>StartUserProcess</b>
function will be executing with interrupts enabled.<span style="mso-spacerun:
yes">&nbsp; </span>The first step is to disable interrupts, since there are
possible race conditions with steps (2) and (3).</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>[What is the race problem?<span style="mso-spacerun:
yes">&nbsp; </span>Consider what happens if a context switch (i.e., timer
interrupt) were to occur between setting the page table registers and setting <b
style='mso-bidi-font-weight:normal'>isUserThread</b> to true.<span
style="mso-spacerun: yes">&nbsp; </span>Look at the <b style='mso-bidi-font-weight:
normal'>Run</b> method.<span style="mso-spacerun: yes">&nbsp; </span>The MMU
registers would be changed for the other process; then when this thread is once
again scheduled, the code in <b style='mso-bidi-font-weight:normal'>Run</b>
will see <b style='mso-bidi-font-weight:normal'>isUserThread</b>==false so it
will not restore the MMU registers.<span style="mso-spacerun: yes">&nbsp;
</span>Merely swapping the order of steps (2) and (3) results in a similar race
condition.]</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The first 3 steps can be done in high-level KPL code, but
steps (4) through (9) must be done in assembly language.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Read through the <b style='mso-bidi-font-weight:normal'>BecomeUserThread</b>
assembly routine in the file <b style='mso-bidi-font-weight:normal'>Switch.s</b>.,
which will take care of steps (4) through (9).<span style="mso-spacerun:
yes">&nbsp; </span><b style='mso-bidi-font-weight:normal'>StartUserProcess</b>
should end with a call to this routine:</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoBodyText3><span style='font-family:Courier'><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>BecomeUserThread (initUserStackTop, initPC, initSystemStackTop)<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The <b style='mso-bidi-font-weight:normal'>BecomeUserThread</b>
will change the mode bits and perform the jump “atomically.” This must be done
atomically since the target jump address is a logical address space.<span
style="mso-spacerun: yes">&nbsp; </span>(The way it does this is a little
tricky: it pushes some stuff onto the system stack to make it look like syscall
or interrupt has occurred, and then executes a “reti” instruction.)</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'>BecomeUserThread</b>
jumps to the user-level<b style='mso-bidi-font-weight:normal'> main</b> routine
and never returns.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h3>Approach to Implementing the Exec Syscall</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>The sequence of steps in <b style='mso-bidi-font-weight:
normal'>InitFirstProcess</b> and <b style='mso-bidi-font-weight:normal'>StartUserProcess</b>
is very similar to what you’ll need when implementing the <b style='mso-bidi-font-weight:
normal'>Exec</b> syscall.<span style="mso-spacerun: yes">&nbsp; </span>You
should be able to copy much of this code when implementing <b style='mso-bidi-font-weight:
normal'>Sys_Handle_Exec</b>.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>One difference is that during an <b style='mso-bidi-font-weight:
normal'>Exec</b>, you already have a process and a thread, so you will not need
to allocate a new <b style='mso-bidi-font-weight:normal'>ProcesControlBlock</b>,
allocate a new <b style='mso-bidi-font-weight:normal'>Thread</b> object, or do
a fork.<span style="mso-spacerun: yes">&nbsp; </span>However, you will have to
work with two virtual address spaces.<span style="mso-spacerun: yes">&nbsp;
</span>The <b style='mso-bidi-font-weight:normal'>LoadExecutable</b> method
requires an empty <b style='mso-bidi-font-weight:normal'>AddrSpace</b> object;
it will then allocate as many frames as necessary and initialize the new
address space.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Unfortunately, <b style='mso-bidi-font-weight:normal'>LoadExecutable</b>
may fail and, if so, your kernel must be able to return to the process that
invoked <b style='mso-bidi-font-weight:normal'>Exec</b> (with an error code, of
course).<span style="mso-spacerun: yes">&nbsp; </span>So you better not get rid
of the old address space until after the new one has been initialized and you
can be sure that no more errors can occur.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>One approach is to create a local variable of type <b
style='mso-bidi-font-weight:normal'>AddrSpace</b>.<span style="mso-spacerun:
yes">&nbsp; </span>Don’t allocate it on the heap, just use something like:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='margin-left:.5in;tab-stops:center 3.0in'><span
style='font-size:10.0pt;font-family:Courier'>var newAddrSpace: AddrSpace = new
AddrSpace<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Then, after the new address space has been set up, you can
copy it into the <b style='mso-bidi-font-weight:normal'>ProcessControlBlock</b>,
e.g.,</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='margin-left:.5in;tab-stops:center 3.0in'><span
style='font-size:10.0pt;font-family:Courier'>currentThread.myProcess.addrSpace
= newAddrSpace<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Don’t forget to free the frames in the previous address
space first, or else valuable kernel resources will remain forever unavailable
and the kernel will eventually freeze up!</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'>Another tricky thing is copying
the filename string from a virtual address space into the kernel address space
where it can be used.<span style='color:black'><span style="mso-spacerun:
yes">&nbsp; </span>The<b style='mso-bidi-font-weight:normal'> filename</b>
argument is a virtual address, but since the kernel is running in <b
style='mso-bidi-font-weight:normal'>Handle_Sys_Exec</b>, paging will be turned
off.</span></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>You’ll
need to copy the characters into an array variable, not something newly
allocated on the heap.<span style="mso-spacerun: yes">&nbsp; </span>It is okay
to put a maximum size on this array and then check that it is not
exceeded.<span style="mso-spacerun: yes">&nbsp; </span>In fact, there is a
constant in <b style='mso-bidi-font-weight:normal'>Kernel.h</b> for this
purpose:<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoFooter style='margin-left:.5in;tab-stops:center 3.0in'><span
style='font-size:10.0pt;font-family:Courier'>const<o:p></o:p></span></p>

<p class=MsoFooter style='margin-left:.5in;tab-stops:center 3.0in'><span
style='font-size:10.0pt;font-family:Courier'><span style="mso-spacerun:
yes">&nbsp; </span><span style='color:black'>MAX_STRING_SIZE = 20</span><o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>(In a
real OS, the maximum string size would be much larger or even nonexistent.<span
style="mso-spacerun: yes">&nbsp; </span>Here, we use a small size to make
testing the limits easier.)<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>Note
that the filename pointer is virtual address, which must be translated into a
physical address; you can’t just use it, as is.<span style="mso-spacerun:
yes">&nbsp; </span>This requires some code to perform the page table lookup in
software.<span style="mso-spacerun: yes">&nbsp; </span>Furthermore, since the
filename string is in virtual space, it may cross page boundaries.<span
style="mso-spacerun: yes">&nbsp; </span>(In fact, the test program contains
cases where this happens!) <o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>Dealing
with the filename is fairly complex, but it turns out that we are giving you a
method<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoFooter style='margin-left:.5in;tab-stops:center 3.0in'><span
style='font-size:10.0pt;font-family:Courier;color:black'>GetStringFromVirtual
(kernelAddr: String, virtAddr, maxSize: int) returns int</span><span
style='font-size:10.0pt;font-family:Courier'><o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>which
will do most of the work.<span style="mso-spacerun: yes">&nbsp; </span>(<b
style='mso-bidi-font-weight:normal'>GetStringFromVirtual</b> calls <b
style='mso-bidi-font-weight:normal'>CopyBytesFromVirtual</b> to do the
copying.)<span style="mso-spacerun: yes">&nbsp; </span>The <b style='mso-bidi-font-weight:
normal'>GetStringFromVirtual</b> method can be used like this:<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='margin-left:.5in;mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style="mso-spacerun: yes">&nbsp;
</span>var<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in;mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp; </span>strBuffer: array [MAX_STRING_SIZE] of char<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in;mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style="mso-spacerun: yes">&nbsp;
</span>...<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in;mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style="mso-spacerun: yes">&nbsp;
</span>i = currentThread.myProcess.addrSpace.GetStringFromVirtual (<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in;mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>&amp; strBuffer,<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in;mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>filename asInteger,<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in;mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>MAX_STRING_SIZE)<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in;mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style="mso-spacerun: yes">&nbsp;
</span>if i &lt; 0<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in;mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style="mso-spacerun:
yes">&nbsp;&nbsp;&nbsp; </span>...error...<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in;mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style="mso-spacerun: yes">&nbsp;
</span>endIf<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>You
might think of allocating a temporary buffer on the heap, but remember that we
do not want to allocate anything on the heap after kernel start-up.<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>[
Recall that the “alloc” expression in KPL always allocates bytes on the
heap.<span style="mso-spacerun: yes">&nbsp; </span>Once the kernel has booted
and is running, you must avoid further allocations.<span style="mso-spacerun:
yes">&nbsp; </span>Why?<span style="mso-spacerun: yes">&nbsp; </span>One
problem is <i style='mso-bidi-font-style:normal'>automatic garbage collection</i>
like you see in Java; we can’t use automatic garbage collection since it would
produce unpredictable delays and might cause the kernel to miss interrupts or,
in the case of a real-time system, miss deadlines.<span style="mso-spacerun:
yes">&nbsp; </span>Also, there is the possibility that the heap might fill up,
and dealing with a “heap full” error in the kernel is difficult.<span
style="mso-spacerun: yes">&nbsp; </span>Another option might be to try to
manage the heap without automatic garbage collection, but years of C++
experience has taught everybody that this is very difficult to do
correctly.<span style="mso-spacerun: yes">&nbsp; </span>This explains why we
have gone to the trouble to create classes like <b style='mso-bidi-font-weight:
normal'>ThreadManager</b> and <b style='mso-bidi-font-weight:normal'>ProcessManager</b>,
instead of simply allocating new <b style='mso-bidi-font-weight:normal'>Thread</b>
and <b style='mso-bidi-font-weight:normal'>ProcessControlBlock</b> objects. ]<o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h3>AllocateRandomFrames</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>The <b style='mso-bidi-font-weight:
normal'>main</b> function includes a function named <b style='mso-bidi-font-weight:
normal'>AllocateRandomFrames</b>, which is aimed only at catching bugs in the
kernel.<span style="mso-spacerun: yes">&nbsp; </span>This function will
allocate every other frame in the physical memory and never release them,
creating a “checkerboard pattern” in memory.<span style="mso-spacerun:
yes">&nbsp; </span>Henceforth, no two pages will ever be allocated to
contiguous page frames.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>Large, multi-byte chunks of data in
the user-level process’s address space will occasionally span page
boundaries.<span style="mso-spacerun: yes">&nbsp; </span>Since these pages may
not be in adjacent frames, your kernel will have to be careful about moving
data to and from user space.<span style="mso-spacerun: yes">&nbsp; </span>What
may appear to the user-level program as a string of adjacent bytes may in fact
be spread all over memory.</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>Some of the user-level syscalls pass
pointers to the kernel.<span style="mso-spacerun: yes">&nbsp; </span>For
example, <b style='mso-bidi-font-weight:normal'>Open</b> passes a pointer to a
string of characters.<span style="mso-spacerun: yes">&nbsp; </span>Keep in mind
that this pointer is a logical address, not a physical address.<span
style="mso-spacerun: yes">&nbsp; </span>As such, you cannot simply use the
pointer as is.<span style="mso-spacerun: yes">&nbsp; </span>Take a look at
these methods <b style='mso-bidi-font-weight:normal'>AddrSpace</b>:</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='margin-left:.5in;tab-stops:center 3.0in'><span
style='font-size:10.0pt;font-family:Courier'>CopyBytesFromVirtual (kernelAddr,
virtAddr, numBytes: <u>int</u>) <u>returns</u> <u>int</u><o:p></o:p></span></p>

<p class=MsoFooter style='margin-left:.5in;tab-stops:center 3.0in'><span
style='font-size:10.0pt;font-family:Courier'>CopyBytesToVirtual (virtAddr,
kernelAddr, numBytes: <u>int</u>) <u>returns</u> <u>int</u><o:p></o:p></span></p>

<p class=MsoFooter style='margin-left:.5in;tab-stops:center 3.0in'><span
style='font-size:10.0pt;font-family:Courier'>GetStringFromVirtual (kernelAddr:
String, virtAddr, maxSize: <u>int</u>) <u>returns</u> <u>int</u><o:p></o:p></span></p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoFooter style='tab-stops:.5in'>An invocation of <b style='mso-bidi-font-weight:
normal'>AllocateRandomFrames</b> has been added just after the <b
style='mso-bidi-font-weight:normal'>FrameManager</b> is initialized.<span
style="mso-spacerun: yes">&nbsp; </span>Please leave this in and do not modify
the <b style='mso-bidi-font-weight:normal'>AllocateRandomFrames</b> routine.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h3>What to Hand In</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Please submit hardcopy of your output and hardcopy your new
versions of the following files:</p>

<p class=MsoFooter style='tab-stops:.5in'><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>Kernel.h<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Courier New"'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span>Kernel.c<o:p></o:p></span></b></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>For
both files, please take a colored pen and circle <i style='mso-bidi-font-style:
normal'><u>exactly</u></i> those parts you have added or changed.<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>Please
submit all of <b style='mso-bidi-font-weight:normal'>Kernel.h</b>.<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>For <b
style='mso-bidi-font-weight:normal'>Kernel.c</b>, please submit only the pages
that have something circled.<span style="mso-spacerun: yes">&nbsp; </span>In
other words, please discard all pages that contain ONLY material that we are
distributing.<span style="mso-spacerun: yes">&nbsp; </span>Please keep the
remaining pages in order.<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>Also,
if you have modified any part of a method or function, please hand in the
entire function, so there is a little context surrounding your code
modifications.<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>As a
second option, which will save on wasted paper, you may perform the deletions
with an editor, instead of discarding physical pages.<span style="mso-spacerun:
yes">&nbsp; </span>You can cut out large sections of code, but please indicate
where material has been clipped out.<span style="mso-spacerun: yes">&nbsp;
</span>Please replaced deleted material with a line like this<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoHeading7><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>XXXXXXXXXXXXXXXXXXX<span
style="mso-spacerun: yes">&nbsp; </span>skipping<span style="mso-spacerun:
yes">&nbsp; </span>XXXXXXXXXXXXXXXXXXX</p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>to
indicate which lines were removed.<span style="mso-spacerun: yes">&nbsp;
</span>But please remember to circle your material with a colored pen.<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>For the output, please run <b style='mso-bidi-font-weight:
normal'>TestProgram1</b> (which exec’s <b style='mso-bidi-font-weight:normal'>TestProgram2</b>)
and submit what it produces.</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h3>Coding Style</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>For
all projects, please follow our coding style.<span style="mso-spacerun:
yes">&nbsp; </span>Make your code match our code as closely as possible.<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>The
goal is for it to be impossible to tell, just by looking at the indentation and
commenting, whether we wrote the code or you wrote the code.<span
style="mso-spacerun: yes">&nbsp; </span>(Of course, your code will be circled!)<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>Please
use our convention in labeling and commenting functions:<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<span style='font-size:10.0pt;font-family:Courier;mso-fareast-font-family:"Times New Roman";
mso-bidi-font-family:"Times New Roman";color:black;mso-ansi-language:EN-US;
mso-fareast-language:EN-US'><br clear=ALL style='page-break-before:always'>
</span>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span style='font-size:10.0pt;font-family:
Courier;color:black'>-----------------------------<span style="mso-spacerun:
yes">&nbsp; </span>Foo<span style="mso-spacerun: yes">&nbsp;
</span>---------------------------------<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp; </span>function Foo ()<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>--<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>-- This routine does....<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>--<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>var x: int<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>x = 1<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>x = 2<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>...<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>x = 9<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>endFunction<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>Methods
are labeled like this, with both class and method name:<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>----------<span
style="mso-spacerun: yes">&nbsp; </span>Condition . Wait<span
style="mso-spacerun: yes">&nbsp; </span>----------<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>method Wait
(mutex: ptr to Mutex)<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-size:10.0pt;
font-family:Courier;color:black'><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>...<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>Note
that indentation is in increments of 2 spaces.<span style="mso-spacerun:
yes">&nbsp; </span>Please be careful to indent statements such as <b
style='mso-bidi-font-weight:normal'>if</b>, <b style='mso-bidi-font-weight:
normal'>while</b>, and <b style='mso-bidi-font-weight:normal'>for</b> properly.<o:p></o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='mso-pagination:none;tab-stops:28.0pt 56.0pt 84.0pt 112.0pt 140.0pt 168.0pt 196.0pt 224.0pt 3.5in 280.0pt 308.0pt 336.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='color:black'>If
you follow these conventions, then even if you throw away other pages, it
should be clear which class the method belongs to.<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<h3><o:p><span style='text-decoration:none'>&nbsp;</span></o:p></h3>

<h3><o:p><span style='text-decoration:none'>&nbsp;</span></o:p></h3>

<h3>Sample Output</h3>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>If your program works correctly, you should see something
like this:</p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<div style='mso-element:para-border-div;border:solid windowtext 1.0pt;
border-bottom:none;padding:1.0pt 5.0pt 0in 5.0pt'>

<p class=MsoNormal style='border:none;mso-border-top-alt:solid windowtext 1.0pt;
mso-border-left-alt:solid windowtext 1.0pt;mso-border-right-alt:solid windowtext 1.0pt;
padding:0in;mso-padding-alt:1.0pt 5.0pt 0in 5.0pt'><span style='font-size:8.0pt;
mso-bidi-font-size:10.0pt;font-family:Courier'>===================<span
style="mso-spacerun: yes">&nbsp; </span>KPL PROGRAM STARTING<span
style="mso-spacerun: yes">&nbsp; </span>===================<o:p></o:p></span></p>

</div>

<div style='mso-element:para-border-div;border-top:none;border-left:solid windowtext 1.0pt;
border-bottom:none;border-right:solid windowtext 1.0pt;mso-border-left-alt:
solid windowtext .5pt;mso-border-right-alt:solid windowtext .5pt;padding:0in 5.0pt 0in 5.0pt'>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Initializing
Thread Scheduler...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Initializing
Process Manager...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Initializing
Thread Manager...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Initializing
Frame Manager...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>AllocateRandomFrames
called.<span style="mso-spacerun: yes">&nbsp;
</span>NUMBER_OF_PHYSICAL_PAGE_FRAMES = 100<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Initializing
Disk Driver...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Initializing
Serial Driver...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Serial
handler thread running...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Initializing
File Manager...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Loading
initial program...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>User-level
program 'TestProgram1' is running...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Testing Syscall Parameter Passing *****<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to call Sys_Yield...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Yield
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Handle_Sys_Yield
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to call Sys_Fork...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Fork
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Handle_Sys_Fork
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to call Sys_Join...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Join
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>processID = 1111<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Handle_Sys_Join
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>processID
= 1111<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to call Sys_Create...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Create
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>virt addr of filename
= 0x0000BFF8<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>filename = MyFileName<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Handle_Sys_Create
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>virt addr
of filename = 0x0000BFF8<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>filename
= MyFileName<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to call Sys_Open...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Open
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>virt addr of filename
= 0x0000BFF8<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>filename = MyFileName<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Handle_Sys_Open
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>virt addr
of filename = 0x0000BFF8<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>filename
= MyFileName<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to call Sys_Read...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Read
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>fileDesc = 2222<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>virt addr of buffer =
0x0000B0A8<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>sizeInBytes = 3333<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Handle_Sys_Read
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>fileDesc
= 2222<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>virt addr
of buffer = 0x0000B0A8<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>sizeInBytes
= 3333<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to call Sys_Write...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Write
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>fileDesc = 4444<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>virt addr of buffer =
0x0000B0A8<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>sizeInBytes = 5555<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Handle_Sys_Write
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>fileDesc
= 4444<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>virt addr
of buffer = 0x0000B0A8<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>sizeInBytes
= 5555<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to call Sys_Seek...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Seek
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>fileDesc = 6666<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>newCurrentPos = 7777<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Handle_Sys_Seek
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>fileDesc
= 6666<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>newCurrentPos
= 7777<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to call Sys_Close...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Close
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>fileDesc = 8888<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Handle_Sys_Close
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>fileDesc
= 8888<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to call Sys_Exit...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>Handle_Sys_Exit
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>returnStatus = 9999<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Handle_Sys_Exit
invoked!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>returnStatus
= 9999<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Syscall Test Complete *****<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Testing Exec Syscall *****<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to call Sys_Exec with a non-existant file...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>Okay<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Okay<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to call Sys_Exec with an overly long file name...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>Okay<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>Okay<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to perform a successful Exec and jump to TestProgram2...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>User-level program
'TestProgram2' is running!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>User-level
program 'TestProgram2' is running!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
About to call Sys_Shutdown...<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****
Should print:<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>*****<span
style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>FATAL ERROR in
UserProgram: &quot;Syscall 'Shutdown' was invoked by a user thread&quot; --
TERMINATING!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>FATAL
ERROR in UserProgram: &quot;Syscall 'Shutdown' was invoked by a user
thread&quot; -- TERMINATING!<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'>(To find
out where execution was when the problem arose, type 'st' at the emulator
prompt.)<o:p></o:p></span></p>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext .5pt;
mso-border-right-alt:solid windowtext .5pt;padding:0in;mso-padding-alt:0in 5.0pt 0in 5.0pt'><span
style='font-size:8.0pt;mso-bidi-font-size:10.0pt;font-family:Courier'><o:p>&nbsp;</o:p></span></p>

</div>

<div style='mso-element:para-border-div;border:solid windowtext 1.0pt;
border-top:none;padding:0in 5.0pt 1.0pt 5.0pt'>

<p class=MsoNormal style='border:none;mso-border-left-alt:solid windowtext 1.0pt;
mso-border-bottom-alt:solid windowtext 1.0pt;mso-border-right-alt:solid windowtext 1.0pt;
padding:0in;mso-padding-alt:0in 5.0pt 1.0pt 5.0pt'><span style='font-size:8.0pt;
mso-bidi-font-size:10.0pt;font-family:Courier'>===================<span
style="mso-spacerun: yes">&nbsp; </span>KPL PROGRAM TERMINATION<span
style="mso-spacerun: yes">&nbsp; </span>===================<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

</div>

</body>

</html>
